<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta name="description" content="i-8 SMART BOT: Calculate deposit penalties, loan interest, and track financial data in KES.">
    <meta name="author" content="Insightful Eight Co. Ltd.">
    <meta name="keywords" content="sacco calculator, Kenya finance, deposit penalty, loan interest, financial tracking">
    <title>i-8 SMART BOT</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231a73e8'%3E%3Cpath d='M19 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2zm-2 14H7v-2h10v2zm0-4H7v-2h10v2zm0-4H7V7h10v2z'/%3E%3C/svg%3E">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Page 1: Calculator Section -->
        <div class="main-page" id="page1">
            <div class="title-container">
                <div>
                    <div class="main-title">i-8 SMART</div>
                    <div class="sub-title">bot</div>
                </div>
            </div>
            <button class="refresh-button" onclick="refreshForm()" aria-label="Refresh form and clear results">
                <i class="fas fa-sync-alt"></i>
            </button>
            <div class="apply-now-section">
                <button onclick="window.open('https://forms.gle/AZejGB89vmrbg9zh8', '_blank')" aria-label="Apply for loan via Google Form">
                    Apply Loan
                    <span class="star-top-left"></span>
                    <span class="star-top-right"></span>
                    <span class="star-bottom-left"></span>
                    <span class="star-bottom-right"></span>
                </button>
            </div>
            <form id="calcForm">
                <label for="type">Type:</label>
                <select id="type" aria-label="Select transaction type: Deposit, Existing Loan, or New Loans" onchange="toggleFields()">
                    <option value="contribution">Deposit</option>
                    <option value="existing_loan">Existing Loan</option>
                    <option value="apply_loan">New Loans</option>
                </select>
                <span id="typeError" class="error"></span>

                <label for="amount">Amount (KES):</label>
                <input type="number" id="amount" min="1" step="100" placeholder="Enter amount in KES" aria-label="Enter amount in Kenyan Shillings (KES)" required>
                <span id="amountError" class="error"></span>

                <div id="contributionFields">
                    <label for="year">Contribution Year:</label>
                    <select id="year" aria-label="Select contribution year" onchange="populateMonths()"></select>
                    <span id="yearError" class="error"></span>

                    <label for="month">Contribution Month:</label>
                    <select id="month" aria-label="Select contribution month" onchange="updateDueDate()"></select>
                    <span id="monthError" class="error"></span>
                </div>

                <div id="dateFields">
                    <label for="dueDate">Due Date:</label>
                    <input type="date" id="dueDate" aria-label="Select due date" required onchange="updateButtonState()">
                    <span id="dueDateError" class="error"></span>

                    <label for="checkDate">Check Date:</label>
                    <input type="date" id="checkDate" aria-label="Select check date" required onchange="updateButtonState()">
                    <span id="checkDateError" class="error"></span>
                </div>

                <div id="loanFields">
                    <label for="loanType">Loan Type:</label>
                    <select id="loanType" aria-label="Select loan type: Short Term, Medium Term, or Long Term" onchange="toggleRepaymentFields()">
                        <option value="short">Short Term (30 Days)</option>
                        <option value="medium">Medium Term (90 Days)</option>
                        <option value="long">Long Term (365 Days)</option>
                    </select>
                    <span id="loanTypeError" class="error"></span>

                    <div id="repaymentFields">
                        <label for="repaymentPeriod">Repayment Period (Months):</label>
                        <select id="repaymentPeriod" aria-label="Select repayment period">
                            <option value="">Select months</option>
                        </select>
                        <span id="repaymentPeriodError" class="error"></span>
                    </div>
                </div>

                <div class="button-container" id="buttonContainer">
                    <button type="button" onclick="calculate()" id="calcButton" aria-label="Calculate penalties or interest">Calc</button>
                </div>
            </form>
            <div class="progress-bar" id="progressBar">
                <div id="progressFill"></div>
            </div>
            <div id="result" class="result"></div>
            <div id="successMessage" class="success-message" style="display: none;"></div>
        </div>

        <!-- Page 2: Financial Overview -->
        <div class="main-page" id="page2" style="display: none;">
            <div class="financial-section">
                <h2>Financial Overview</h2>
                <form id="periodSelectForm">
                    <label for="reportPeriod">Select Period:</label>
                    <select id="reportPeriod" aria-label="Select report period" onchange="populateReportPeriods()">
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                    <label for="reportMonth">Select Month/Quarter/Year:</label>
                    <select id="reportMonth" aria-label="Select report month, quarter, or year" onchange="updateFinancialData()"></select>
                </form>
                <div id="balanceSheet">
                    <h3>Balance Sheet</h3>
                    <div class="loading-spinner" id="balanceSheetSpinner" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                    <table class="balance-sheet-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Amount (KES)</th>
                            </tr>
                        </thead>
                        <tbody id="balanceSheetBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Page 3: Member Contributions -->
        <div class="main-page" id="page3" style="display: none;">
            <div class="financial-section">
                <h2>Member Contributions</h2>
                <div class="loading-spinner" id="membersSpinner" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </div>
                <div id="memberContributions">
                    <table class="member-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Contribution (KES)</th>
                                <th>Shares</th>
                                <th>Last Contribution</th>
                                <th>Loan Limit (KES)</th>
                            </tr>
                        </thead>
                        <tbody id="memberTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Page 4: Company Behavior Report -->
        <div class="main-page" id="page4" style="display: none;">
            <div class="financial-section">
                <h2>Company Behavior Report</h2>
                <form id="behaviorReportForm">
                    <label for="behaviorPeriod">Select Period:</label>
                    <select id="behaviorPeriod" aria-label="Select report period" onchange="populateBehaviorPeriods()">
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                    <label for="behaviorMonth">Select Month/Quarter/Year:</label>
                    <select id="behaviorMonth" aria-label="Select report month, quarter, or year" onchange="updateBehaviorReport()"></select>
                </form>
                <div class="loading-spinner" id="behaviorSpinner" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </div>
                <div id="behaviorReport">
                    <h3>Financial Summary</h3>
                    <table class="balance-sheet-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody id="behaviorReportBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="pagination-controls">
            <button id="prevMainPage" onclick="changeMainPage(-1)" disabled aria-label="Previous page">
                <i class="fas fa-chevron-left"></i>
            </button>
            <span id="mainPageInfo">Page 1 of 4</span>
            <button id="nextMainPage" onclick="changeMainPage(1)" aria-label="Next page">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <div id="resultModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeResultModal()" aria-label="Close results">&times;</button>
                <div id="modalResult"></div>
            </div>
        </div>
    </div>

    <script>
    const CONFIG = {
        CONTRIBUTION_PENALTY: 0.30,
        CONTRIBUTION_DAILY_PENALTY: 0.01,
        LOAN_SHORT_INTEREST: 0.05,
        LOAN_MEDIUM_INTEREST: 0.10,
        LOAN_LONG_INTEREST: 0.15,
        LOAN_SHORT_MINIMUM: 2000,
        LOAN_MEDIUM_MINIMUM: 5000,
        LOAN_LONG_MINIMUM: 30000,
        ROLLOVER_INTEREST: 0.05,
        LOAN_DAILY_PENALTY: 0.005,
        PENALTY_START_DAY: 1,
        API_BASE_URL: 'https://i8-smart-backend.onrender.com/api',
        MAX_RETRIES: 3,
        RETRY_DELAY: 2000,
        CACHE_VALIDITY: 24 * 60 * 60 * 1000 // 24 hours
    };

    const elements = {
        type: document.getElementById('type'),
        amount: document.getElementById('amount'),
        contributionFields: document.getElementById('contributionFields'),
        year: document.getElementById('year'),
        month: document.getElementById('month'),
        dateFields: document.getElementById('dateFields'),
        dueDate: document.getElementById('dueDate'),
        checkDate: document.getElementById('checkDate'),
        loanFields: document.getElementById('loanFields'),
        loanType: document.getElementById('loanType'),
        repaymentFields: document.getElementById('repaymentFields'),
        repaymentPeriod: document.getElementById('repaymentPeriod'),
        calcButton: document.getElementById('calcButton'),
        buttonContainer: document.getElementById('buttonContainer'),
        result: document.getElementById('result'),
        successMessage: document.getElementById('successMessage'),
        progressBar: document.getElementById('progressBar'),
        progressFill: document.getElementById('progressFill'),
        resultModal: document.getElementById('resultModal'),
        modalResult: document.getElementById('modalResult'),
        errors: {
            type: document.getElementById('typeError'),
            amount: document.getElementById('amountError'),
            year: document.getElementById('yearError'),
            month: document.getElementById('monthError'),
            dueDate: document.getElementById('dueDateError'),
            checkDate: document.getElementById('checkDateError'),
            loanType: document.getElementById('loanTypeError'),
            repaymentPeriod: document.getElementById('repaymentPeriodError')
        },
        spinners: {
            balanceSheet: document.getElementById('balanceSheetSpinner'),
            members: document.getElementById('membersSpinner'),
            behavior: document.getElementById('behaviorSpinner')
        }
    };

    let isCalculating = false;
    let lastResult = null;
    let lastResultText = '';
    let currentMainPage = 1;
    let currentMembers = [];
    let dataCache = null;
    let forceRefresh = false;

    function sanitizeInput(input) {
        const div = document.createElement('div');
        div.textContent = input;
        return div.innerHTML;
    }

    function logError(message, error) {
        console.error(`[i-8 SMART BOT] ${message}`, error);
    }

    function showProgress() {
        elements.progressBar.classList.add('active');
        elements.progressFill.style.width = '0%';
        let progress = 0;
        const interval = setInterval(() => {
            progress += 10;
            elements.progressFill.style.width = `${progress}%`;
            if (progress >= 100) clearInterval(interval);
        }, 100);
    }

    function hideProgress() {
        elements.progressBar.classList.remove('active');
        elements.progressFill.style.width = '0%';
    }

    function showSpinner(element) {
        element.style.display = 'block';
    }

    function hideSpinner(element) {
        element.style.display = 'none';
    }

    function showSuccessMessage(message) {
        elements.successMessage.textContent = message;
        elements.successMessage.style.display = 'block';
        setTimeout(() => {
            elements.successMessage.style.display = 'none';
        }, 5000);
    }

    async function fetchWithRetry(url, options = {}, retries = CONFIG.MAX_RETRIES) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                console.log(`Fetched data from ${url}:`, data);
                return data;
            } catch (error) {
                if (i < retries - 1) {
                    console.log(`Retrying fetch (${i + 1}/${retries}) for ${url}`);
                    await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY));
                    continue;
                }
                throw error;
            }
        }
    }

    function saveDataToStorage(data) {
        try {
            localStorage.setItem('financialData', JSON.stringify({
                data: data,
                timestamp: new Date().getTime()
            }));
            console.log('Saved data to localStorage:', data);
        } catch (error) {
            logError('Failed to save financial data to storage', error);
        }
    }

    function loadDataFromStorage() {
        try {
            const stored = localStorage.getItem('financialData');
            if (!stored) return null;
            const { data, timestamp } = JSON.parse(stored);
            const now = new Date().getTime();
            if (now - timestamp > CONFIG.CACHE_VALIDITY) {
                console.log('Cached data is stale, discarding');
                localStorage.removeItem('financialData');
                return null;
            }
            console.log('Loaded data from localStorage:', data);
            return data;
        } catch (error) {
            logError('Failed to load financial data from storage', error);
            return null;
        }
    }

    async function fetchDataIfStale() {
        const cachedData = loadDataFromStorage();
        if (cachedData && !forceRefresh) {
            dataCache = cachedData;
            console.log('Using cached data:', dataCache);
            return dataCache;
        }
        try {
            const data = await fetchWithRetry(`${CONFIG.API_BASE_URL}/data`);
            if (!data || Object.keys(data).length === 0) {
                throw new Error('Empty or invalid data received from API');
            }
            dataCache = data;
            saveDataToStorage(data);
            forceRefresh = false;
            console.log('Fetched fresh data:', dataCache);
            return dataCache;
        } catch (error) {
            logError('Failed to fetch fresh data', error);
            dataCache = null;
            localStorage.removeItem('financialData');
            throw error;
        }
    }

    function debugDataStructure() {
        fetchDataIfStale().then(() => {
            console.log('Data structure:', JSON.stringify(dataCache, null, 2));
            if (dataCache && dataCache.monthly_reports) {
                console.log('Monthly reports keys:', Object.keys(dataCache.monthly_reports));
            }
            if (dataCache && dataCache.member_contributions) {
                console.log('Member contributions:', dataCache.member_contributions);
            }
        }).catch(error => {
            logError('Failed to debug data structure', error);
        });
    }

    function validateInputs() {
        const errors = [];
        const type = elements.type.value;
        const amount = parseFloat(elements.amount.value) || 0;
        const year = elements.year.value;
        const month = elements.month.value;
        const loanType = elements.loanType.value;
        const repaymentPeriod = elements.repaymentPeriod.value;
        let dueDate, checkDate;

        if (type !== 'apply_loan') {
            dueDate = new Date(elements.dueDate.value + 'T00:00:00');
            checkDate = new Date(elements.checkDate.value + 'T00:00:00');
        }

        Object.values(elements.errors).forEach(error => error.style.display = 'none');

        if (!type) {
            elements.errors.type.textContent = 'Please select a type.';
            elements.errors.type.style.display = 'block';
            errors.push('Invalid type');
        }

        if (amount <= 0 || isNaN(amount)) {
            elements.errors.amount.textContent = 'Amount must be a positive number in KES.';
            elements.errors.amount.style.display = 'block';
            errors.push('Invalid amount');
        } else if (type === 'existing_loan' || type === 'apply_loan') {
            if (loanType === 'short' && amount < CONFIG.LOAN_SHORT_MINIMUM) {
                elements.errors.amount.textContent = `Amount for Short Term loan must be at least ${CONFIG.LOAN_SHORT_MINIMUM} KES.`;
                elements.errors.amount.style.display = 'block';
                errors.push('Amount below minimum for Short Term loan');
            } else if (loanType === 'medium' && amount < CONFIG.LOAN_MEDIUM_MINIMUM) {
                elements.errors.amount.textContent = `Amount for Medium Term loan must be at least ${CONFIG.LOAN_MEDIUM_MINIMUM} KES.`;
                elements.errors.amount.style.display = 'block';
                errors.push('Amount below minimum for Medium Term loan');
            } else if (loanType === 'long' && amount < CONFIG.LOAN_LONG_MINIMUM) {
                elements.errors.amount.textContent = `Amount for Long Term loan must be at least ${CONFIG.LOAN_LONG_MINIMUM} KES.`;
                elements.errors.amount.style.display = 'block';
                errors.push('Amount below minimum for Long Term loan');
            }
        }

        if (type === 'contribution') {
            if (!year) {
                elements.errors.year.textContent = 'Please select a year.';
                elements.errors.year.style.display = 'block';
                errors.push('Invalid year');
            }
            if (!month) {
                elements.errors.month.textContent = 'Please select a month.';
                elements.errors.month.style.display = 'block';
                errors.push('Invalid month');
            }
            if (isNaN(dueDate.getTime())) {
                elements.errors.dueDate.textContent = 'Invalid due date.';
                elements.errors.dueDate.style.display = 'block';
                errors.push('Invalid due date');
            }
            if (isNaN(checkDate.getTime())) {
                elements.errors.checkDate.textContent = 'Invalid check date.';
                elements.errors.checkDate.style.display = 'block';
                errors.push('Invalid check date');
            }
            if (dueDate.getMonth() + 1 !== parseInt(month.split('-')[1]) || dueDate.getFullYear() !== parseInt(year)) {
                elements.errors.dueDate.textContent = 'Due date must match selected month and year.';
                elements.errors.dueDate.style.display = 'block';
                errors.push('Due date mismatch');
            }
        }

        if (type === 'existing_loan') {
            if (!loanType) {
                elements.errors.loanType.textContent = 'Please select a loan type.';
                elements.errors.loanType.style.display = 'block';
                errors.push('Invalid loan type');
            }
            if (isNaN(dueDate.getTime())) {
                elements.errors.dueDate.textContent = 'Invalid due date.';
                elements.errors.dueDate.style.display = 'block';
                errors.push('Invalid due date');
            }
            if (isNaN(checkDate.getTime())) {
                elements.errors.checkDate.textContent = 'Invalid check date.';
                elements.errors.checkDate.style.display = 'block';
                errors.push('Invalid check date');
            }
        }

        if (type === 'apply_loan') {
            if (!loanType) {
                elements.errors.loanType.textContent = 'Please select a loan type.';
                elements.errors.loanType.style.display = 'block';
                errors.push('Invalid loan type');
            }
            if (!repaymentPeriod) {
                elements.errors.repaymentPeriod.textContent = 'Please select a repayment period.';
                elements.errors.repaymentPeriod.style.display = 'block';
                errors.push('Invalid repayment period');
            }
        }

        return errors.length === 0 ? null : errors.join(', ');
    }

    function calculateContributionPenalty(amount, daysDelayed) {
        if (daysDelayed < CONFIG.PENALTY_START_DAY) return 0;
        if (daysDelayed <= 7) return amount * CONFIG.CONTRIBUTION_PENALTY;
        return (amount * CONFIG.CONTRIBUTION_PENALTY) + (amount * CONFIG.CONTRIBUTION_DAILY_PENALTY * (daysDelayed - 7));
    }

    function calculateLoanOwed(amount, daysDelayed, loanType) {
        let interest;
        if (loanType === 'short') {
            interest = amount * CONFIG.LOAN_SHORT_INTEREST;
        } else if (loanType === 'medium') {
            interest = amount * CONFIG.LOAN_MEDIUM_INTEREST;
        } else {
            interest = amount * CONFIG.LOAN_LONG_INTEREST;
        }
        let totalOwed = amount + interest;
        let penalty = 0;
        let rollOverInterest = 0;
        if (daysDelayed > 7) {
            const rolledAmount = amount + interest;
            rollOverInterest = rolledAmount * CONFIG.ROLLOVER_INTEREST;
            penalty = rolledAmount * CONFIG.LOAN_DAILY_PENALTY * (daysDelayed - 7);
            totalOwed = amount + interest + rollOverInterest + penalty;
        }
        return { totalOwed, interest, penalty, rollOverInterest };
    }

    function calculateApplyLoan(amount, loanType, repaymentPeriod) {
        const interestRate = loanType === 'short' ? CONFIG.LOAN_SHORT_INTEREST :
                            loanType === 'medium' ? CONFIG.LOAN_MEDIUM_INTEREST :
                            CONFIG.LOAN_LONG_INTEREST;
        const interest = amount * interestRate;
        const totalOwed = amount + interest;
        const monthlyPayment = totalOwed / repaymentPeriod;
        const monthlyInterest = interest / repaymentPeriod;
        const monthlyPrincipal = amount / repaymentPeriod;
        let balance = totalOwed;
        let schedule = [];
        for (let i = 1; i <= repaymentPeriod; i++) {
            balance -= monthlyPayment;
            if (balance < 0) balance = 0;
            schedule.push({
                month: i,
                payment: monthlyPayment.toFixed(2),
                interest: monthlyInterest.toFixed(2),
                principal: monthlyPrincipal.toFixed(2),
                balance: balance.toFixed(2)
            });
        }
        return { totalOwed, interest, amortization: schedule, termMonths: repaymentPeriod };
    }

    function saveCalculation(data) {
        try {
            const history = JSON.parse(localStorage.getItem('calculations') || '[]');
            history.push({ ...data, timestamp: new Date().toISOString() });
            localStorage.setItem('calculations', JSON.stringify(history));
        } catch (error) {
            logError('Failed to save calculation', error);
        }
    }

    async function submitContribution(amount, month) {
        try {
            const response = await fetchWithRetry(`${CONFIG.API_BASE_URL}/add-contribution`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'addContribution',
                    amount: amount,
                    month: month,
                    contributionDate: new Date().toISOString().split('T')[0]
                })
            });
            if (response.message === 'Contribution added successfully') {
                showSuccessMessage(`Contribution of KES ${amount.toFixed(2)} added successfully.`);
                dataCache = null;
                localStorage.removeItem('financialData');
                forceRefresh = true;
                if (currentMainPage === 3) updateFinancialData();
            } else {
                throw new Error('Unexpected response from server');
            }
        } catch (error) {
            logError('Failed to submit contribution', error);
            elements.result.innerHTML = `<span style="color: #e74c3c;">Error submitting contribution: ${error.message}. Please try again.</span>`;
        }
    }

    function populateYears() {
        const yearSelect = elements.year;
        yearSelect.innerHTML = '';
        const currentYear = new Date().getFullYear();
        for (let year = 2024; year <= currentYear + 1; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.text = year;
            yearSelect.appendChild(option);
        }
        yearSelect.value = currentYear;
        populateMonths();
    }

    function populateMonths() {
        const year = parseInt(elements.year.value);
        const monthSelect = elements.month;
        monthSelect.innerHTML = '';
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth();
        const startMonth = year === 2024 ? 0 : 0;
        const maxMonth = year === currentYear ? currentMonth + 1 : 11;
        const monthAbbr = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        for (let month = startMonth; month <= maxMonth; month++) {
            const monthName = monthAbbr[month];
            const optionValue = `${year}-${(month + 1).toString().padStart(2, '0')}`;
            const option = document.createElement('option');
            option.value = optionValue;
            option.text = `${monthName} ${year}`;
            monthSelect.appendChild(option);
        }

        if (monthSelect.children.length === 0) {
            const option = document.createElement('option');
            option.value = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}`;
            option.text = `${monthAbbr[currentMonth]} ${currentYear}`;
            monthSelect.appendChild(option);
        }
        updateDueDate();
    }

    function populateReportPeriods() {
        const periodSelect = document.getElementById('reportPeriod');
        const monthSelect = document.getElementById('reportMonth');
        monthSelect.innerHTML = '<option value="">Select a period</option>';
        showSpinner(elements.spinners.balanceSheet);
        fetchDataIfStale().then(data => {
            if (!data || !data.monthly_reports) {
                console.log('No monthly_reports data available:', data);
                document.getElementById('balanceSheetBody').innerHTML = '<tr><td colspan="2">No financial data available. Please submit data via admin panel.</td></tr>';
                monthSelect.innerHTML = '<option value="">No periods available</option>';
                hideSpinner(elements.spinners.balanceSheet);
                return;
            }
            const months = Object.keys(data.monthly_reports).filter(m => m.match(/^\d{4}-\d{2}$/)).sort();
            console.log('Available periods for Page 2:', months);
            const monthAbbr = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            if (periodSelect.value === 'monthly') {
                months.forEach(month => {
                    const [year, monthNum] = month.split('-').map(Number);
                    const option = document.createElement('option');
                    option.value = month;
                    option.text = `${monthAbbr[monthNum - 1]} ${year}`;
                    monthSelect.appendChild(option);
                });
            } else if (periodSelect.value === 'quarterly') {
                const quarters = {};
                months.forEach(month => {
                    const [year, monthNum] = month.split('-').map(Number);
                    const quarter = `${year}-Q${Math.ceil(monthNum / 3)}`;
                    if (!quarters[quarter]) {
                        quarters[quarter] = true;
                        const option = document.createElement('option');
                        option.value = quarter;
                        option.text = `${quarter}`;
                        monthSelect.appendChild(option);
                    }
                });
            } else if (periodSelect.value === 'yearly') {
                const years = [...new Set(months.map(m => m.split('-')[0]))].sort();
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.text = year;
                    monthSelect.appendChild(option);
                });
            }
            if (monthSelect.children.length > 1) {
                const latestPeriod = months[months.length - 1] || '';
                monthSelect.value = periodSelect.value === 'monthly' ? latestPeriod :
                                    periodSelect.value === 'quarterly' ? `${latestPeriod.split('-')[0]}-Q${Math.ceil(parseInt(latestPeriod.split('-')[1]) / 3)}` :
                                    latestPeriod.split('-')[0];
                if (monthSelect.value) updateFinancialData();
            } else {
                document.getElementById('balanceSheetBody').innerHTML = '<tr><td colspan="2">No periods available. Please submit data via admin panel.</td></tr>';
            }
            hideSpinner(elements.spinners.balanceSheet);
        }).catch(error => {
            logError('Error loading periods for Page 2', error);
            document.getElementById('balanceSheetBody').innerHTML = `<tr><td colspan="2">Failed to load periods: ${error.message}. Please try again or contact support.</td></tr>`;
            monthSelect.innerHTML = '<option value="">Error loading periods</option>';
            hideSpinner(elements.spinners.balanceSheet);
        });
    }

    function populateBehaviorPeriods() {
        const periodSelect = document.getElementById('behaviorPeriod');
        const monthSelect = document.getElementById('behaviorMonth');
        monthSelect.innerHTML = '<option value="">Select a period</option>';
        showSpinner(elements.spinners.behavior);
        fetchDataIfStale().then(data => {
            if (!data || !data.monthly_reports) {
                console.log('No monthly_reports data available:', data);
                document.getElementById('behaviorReportBody').innerHTML = '<tr><td colspan="2">No report data available. Please submit data via admin panel.</td></tr>';
                monthSelect.innerHTML = '<option value="">No periods available</option>';
                hideSpinner(elements.spinners.behavior);
                return;
            }
            const months = Object.keys(data.monthly_reports).filter(m => m.match(/^\d{4}-\d{2}$/)).sort();
            console.log('Available periods for Page 4:', months);
            const monthAbbr = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            if (periodSelect.value === 'monthly') {
                months.forEach(month => {
                    const [year, monthNum] = month.split('-').map(Number);
                    const option = document.createElement('option');
                    option.value = month;
                    option.text = `${monthAbbr[monthNum - 1]} ${year}`;
                    monthSelect.appendChild(option);
                });
            } else if (periodSelect.value === 'quarterly') {
                const quarters = {};
                months.forEach(month => {
                    const [year, monthNum] = month.split('-').map(Number);
                    const quarter = `${year}-Q${Math.ceil(monthNum / 3)}`;
                    if (!quarters[quarter]) {
                        quarters[quarter] = true;
                        const option = document.createElement('option');
                        option.value = quarter;
                        option.text = `${quarter}`;
                        monthSelect.appendChild(option);
                    }
                });
            } else if (periodSelect.value === 'yearly') {
                const years = [...new Set(months.map(m => m.split('-')[0]))].sort();
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.text = year;
                    monthSelect.appendChild(option);
                });
            }
            if (monthSelect.children.length > 1) {
                const latestPeriod = months[months.length - 1] || '';
                monthSelect.value = periodSelect.value === 'monthly' ? latestPeriod :
                                    periodSelect.value === 'quarterly' ? `${latestPeriod.split('-')[0]}-Q${Math.ceil(parseInt(latestPeriod.split('-')[1]) / 3)}` :
                                    latestPeriod.split('-')[0];
                if (monthSelect.value) updateBehaviorReport();
            } else {
                document.getElementById('behaviorReportBody').innerHTML = '<tr><td colspan="2">No periods available. Please submit data via admin panel.</td></tr>';
            }
            hideSpinner(elements.spinners.behavior);
        }).catch(error => {
            logError('Error loading behavior periods for Page 4', error);
            document.getElementById('behaviorReportBody').innerHTML = `<tr><td colspan="2">Failed to load periods: ${error.message}. Please try again or contact support.</td></tr>`;
            monthSelect.innerHTML = '<option value="">Error loading periods</option>';
            hideSpinner(elements.spinners.behavior);
        });
    }

    function toggleRepaymentFields() {
        const type = elements.type.value;
        const loanType = elements.loanType.value;
        elements.repaymentFields.style.display = (type === 'apply_loan' && loanType) ? 'block' : 'none';
        elements.repaymentFields.classList.toggle('show', type === 'apply_loan' && loanType);
        elements.repaymentPeriod.innerHTML = '<option value="">Select months</option>';
        if (type === 'apply_loan' && loanType) {
            let options = [];
            if (loanType === 'short') {
                options = [1];
            } else if (loanType === 'medium') {
                options = [2, 3];
            } else if (loanType === 'long') {
                options = [4, 5, 6, 7, 8, 9, 10, 11, 12];
            }
            options.forEach(months => {
                const option = document.createElement('option');
                option.value = months;
                option.text = months;
                elements.repaymentPeriod.appendChild(option);
            });
        }
        updateButtonState();
    }

    function toggleFields() {
        const type = elements.type.value;
        elements.contributionFields.style.display = type === 'contribution' ? 'block' : 'none';
        elements.contributionFields.classList.toggle('show', type === 'contribution');
        elements.loanFields.style.display = (type === 'existing_loan' || type === 'apply_loan') ? 'block' : 'none';
        elements.loanFields.classList.toggle('show', type === 'existing_loan' || type === 'apply_loan');
        elements.dateFields.style.display = (type === 'contribution' || type === 'existing_loan') ? 'block' : 'none';
        elements.dateFields.classList.toggle('show', type === 'contribution' || type === 'existing_loan');
        elements.dueDate.disabled = type === 'contribution';
        if (type === 'contribution') {
            populateYears();
        } else {
            elements.dueDate.value = '';
            elements.checkDate.value = '';
        }
        toggleRepaymentFields();
        updateButtonState();
    }

    function updateDueDate() {
        const type = elements.type.value;
        if (type === 'contribution' && elements.contributionFields.style.display !== 'none') {
            const selectedMonth = elements.month.value.split('-');
            const year = parseInt(selectedMonth[0]);
            const month = parseInt(selectedMonth[1]) - 1;
            let dueDate = new Date(Date.UTC(year, month + 1, 1, 12, 0, 0));
            dueDate.setUTCDate(10);
            elements.dueDate.value = isNaN(dueDate.getTime()) ? new Date().toISOString().split('T')[0] : new Date(dueDate).toISOString().split('T')[0];
        }
        updateButtonState();
    }

    function updateButtonState() {
        const type = elements.type.value;
        const amount = elements.amount.value;
        const year = elements.year.value;
        const month = elements.month.value;
        const dueDate = elements.dueDate.value;
        const checkDate = elements.checkDate.value;
        const loanType = elements.loanType.value;
        const repaymentPeriod = elements.repaymentPeriod.value;

        const isAmountValid = amount && parseFloat(amount) > 0;
        let isValid = false;

        if (type === 'contribution') {
            isValid = isAmountValid && year && month && dueDate && checkDate;
        } else if (type === 'existing_loan') {
            isValid = isAmountValid && loanType && dueDate && checkDate;
        } else if (type === 'apply_loan') {
            isValid = isAmountValid && loanType && repaymentPeriod;
        }

        elements.calcButton.disabled = isCalculating || !isValid;
    }

    function refreshForm() {
        elements.type.value = 'contribution';
        elements.amount.value = '';
        elements.year.value = '';
        elements.month.value = '';
        elements.dueDate.value = '';
        elements.checkDate.value = '';
        elements.loanType.value = 'short';
        elements.repaymentPeriod.value = '';

        Object.values(elements.errors).forEach(error => {
            error.textContent = '';
            error.style.display = 'none';
        });

        elements.result.innerHTML = '';
        elements.modalResult.innerHTML = '';
        elements.successMessage.style.display = 'none';
        elements.resultModal.style.display = 'none';
        lastResult = null;
        lastResultText = '';

        // Clear cached data and force refresh
        localStorage.removeItem('financialData');
        dataCache = null;
        forceRefresh = true;

        toggleFields();
        populateYears();
        updateButtonState();

        // Refresh data for current page
        if (currentMainPage === 2) {
            populateReportPeriods();
        } else if (currentMainPage === 3) {
            updateFinancialData();
        } else if (currentMainPage === 4) {
            populateBehaviorPeriods();
        }
    }

    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let yOffset = 10;
        const margin = 10;

        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.text('i-8 SMART BOT Financial Report', 105, yOffset, { align: 'center' });
        yOffset += 10;

        const today = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' });
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.text(`Generated on: ${today}`, 200, yOffset, { align: 'right' });
        yOffset += 10;

        let content = `This document provides a detailed summary of your financial calculation from i-8 SMART BOT as of ${today}.`;
        let lines = doc.splitTextToSize(content, 190);
        doc.text(lines, margin, yOffset);
        yOffset += lines.length * 6 + 10;

        if (lastResult.type === 'contribution') {
            const penalty = lastResult.penalty;
            const dueDate = new Date(lastResult.dueDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' });
            const monthParts = lastResult.month.split('-');
            const monthName = new Date(monthParts[0], monthParts[1] - 1).toLocaleString('en-GB', { month: 'long' });
            content = `Deposit of KES ${lastResult.amount.toFixed(2)} for ${monthName} ${monthParts[0]} was due on ${dueDate}. `;
            content += `A delay of ${lastResult.daysDelayed} days was recorded.\n\n`;
            content += `Penalty Details:\n`;
            content += penalty > 0
                ? `- Flat penalty of 30% (KES ${(lastResult.amount * CONFIG.CONTRIBUTION_PENALTY).toFixed(2)}) applies for delays up to 7 days.\n`
                + `- Additional 1% per day (KES ${(lastResult.amount * CONFIG.CONTRIBUTION_DAILY_PENALTY).toFixed(2)}/day) for delays beyond 7 days.\n`
                + `- Total Penalty: KES ${penalty.toFixed(2)}.\n`
                : `- No penalty applied (delay less than ${CONFIG.PENALTY_START_DAY} day).\n`;
            content += `\nTotal Amount Owed: KES ${lastResult.totalOwed.toFixed(2)}.`;
            lines = doc.splitTextToSize(content, 190);
            doc.setFontSize(9);
            doc.text(lines, margin, yOffset);
            yOffset += lines.length * 6 + 10;
        } else if (lastResult.type === 'existing_loan') {
            const dueDate = new Date(lastResult.dueDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' });
            let loanType, interestRate;
            if (lastResult.loanType === 'short') {
                loanType = 'Short Term (30 Days)';
                interestRate = '5%';
            } else if (lastResult.loanType === 'medium') {
                loanType = 'Medium Term (90 Days)';
                interestRate = '10%';
            } else {
                loanType = 'Long Term (365 Days)';
                interestRate = '15%';
            }
            content = `Your ${loanType} existing loan of KES ${lastResult.amount.toFixed(2)} was due on ${dueDate}, with a delay of ${lastResult.daysDelayed} days.\n\n`;
            content += `Loan Details:\n`;
            content += `- Initial Interest: KES ${lastResult.interest.toFixed(2)} (${interestRate} rate).\n`;
            if (lastResult.daysDelayed > 7) {
                content += `- Roll-over Interest: KES ${lastResult.rollOverInterest.toFixed(2)} (5% of principal plus initial interest).\n`;
                content += `- Penalty: KES ${lastResult.penalty.toFixed(2)} (0.5% per day after 7 days).\n`;
            } else {
                content += `- No roll-over interest or penalty applied (delay â‰¤ 7 days).\n`;
            }
            content += `\nTotal Amount Owed: KES ${lastResult.totalOwed.toFixed(2)}.`;
            lines = doc.splitTextToSize(content, 190);
            doc.setFontSize(9);
            doc.text(lines, margin, yOffset);
            yOffset += lines.length * 6 + 10;
        } else if (lastResult.type === 'apply_loan') {
            let loanType, interestRate;
            if (lastResult.loanType === 'short') {
                loanType = 'Short Term (30 Days)';
                interestRate = '5%';
            } else if (lastResult.loanType === 'medium') {
                loanType = 'Medium Term (90 Days)';
                interestRate = '10%';
            } else {
                loanType = 'Long Term (365 Days)';
                interestRate = '15%';
            }
            content = `Your ${loanType} loan of KES ${lastResult.amount.toFixed(2)} over ${lastResult.repaymentPeriod} months.\n\n`;
            content += `Loan Details:\n`;
            content += `- Interest: KES ${lastResult.interest.toFixed(2)} (${interestRate} rate).\n`;
            content += `- Total Amount to Pay: KES ${lastResult.totalOwed.toFixed(2)}.`;
            lines = doc.splitTextToSize(content, 190);
            doc.setFontSize(9);
            doc.text(lines, margin, yOffset);
            yOffset += lines.length * 6 + 10;

            if (lastResult.amortization && lastResult.amortization.length > 0) {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.text('Amortization Schedule:', margin, yOffset);
                yOffset += 10;

                const headers = ['Month', 'Payment (KES)', 'Interest (KES)', 'Principal (KES)', 'Balance (KES)'];
                const tableData = lastResult.amortization.map(row => [
                    row.month.toString(),
                    row.payment,
                    row.interest,
                    row.principal,
                    row.balance
                ]);
                doc.autoTable({
                    head: [headers],
                    body: tableData,
                    startY: yOffset,
                    styles: { fontSize: 10, cellPadding: 2 },
                    headStyles: { fillColor: [26, 115, 232], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [245, 247, 250] }
                });
                yOffset = doc.lastAutoTable.finalY + 10;
            }
        }

        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        content = `Kindly update your account to help i-8 Ltd grow and serve you better.`;
        lines = doc.splitTextToSize(content, 190);
        doc.text(lines, margin, yOffset);
        yOffset += lines.length * 6;

        doc.setFont('helvetica', 'bold');
        doc.text('Regards,', margin, yOffset);
        yOffset += 6;
        doc.setFont('helvetica', 'italic');
        doc.text('i-8 Ltd. (insightfuleightcoltd@gmail.com)', margin, yOffset);

        return doc.output('blob');
    }

    async function shareResults() {
        if (!lastResult) {
            alert('No results available to share. Please calculate first.');
            return;
        }
        try {
            const pdfBlob = await generatePDF();
            const pdfFile = new File([pdfBlob], 'i8-smart-bot-result.pdf', { type: 'application/pdf' });
            if (navigator.share) {
                await navigator.share({
                    files: [pdfFile],
                    title: 'i-8 SMART BOT Calculation Results',
                    text: 'View your financial calculation results from i-8 SMART BOT.'
                });
            } else {
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'i8-smart-bot-result.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('PDF downloaded. You can now share it via WhatsApp or email.');
            }
        } catch (error) {
            logError('Sharing failed', error);
            const pdfBlob = await generatePDF();
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'i8-smart-bot-result.pdf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Sharing not supported. PDF downloaded for manual sharing.');
        }
    }

    async function calculate() {
        const validationError = validateInputs();
        if (validationError) {
            elements.result.innerHTML = `<span style="color: #e74c3c;">${sanitizeInput(validationError)}</span>`;
            return;
        }

        isCalculating = true;
        elements.calcButton.classList.add('loading');
        elements.calcButton.disabled = true;
        showProgress();

        try {
            await new Promise(resolve => setTimeout(resolve, 1000));

            const type = elements.type.value;
            const amount = parseFloat(elements.amount.value);
            let tableHTML = `
                <button class="share-button" onclick="shareResults()" aria-label="Share results"><i class="fas fa-share-alt"></i> Share</button>
                <table style="width: 100%; border-collapse: collapse; font-size: clamp(0.7rem, 2vw, 0.8rem);">
                    <tr style="background: linear-gradient(135deg, #1a73e8, #4285f4); color: #fff;">
                        <th style="padding: 0.4rem; border: 1px solid #1a73e8;">Field</th>
                        <th style="padding: 0.4rem; border: 1px solid #1a73e8;">Value</th>
                    </tr>
            `;
            let resultText = 'i-8 SMART BOT Calculation Results\n\n';

            if (type === 'contribution') {
                const dueDate = new Date(elements.dueDate.value + 'T00:00:00');
                const checkDate = new Date(elements.checkDate.value + 'T00:00:00');
                const daysDelayed = Math.max(0, Math.floor((checkDate - dueDate) / (24 * 60 * 60 * 1000)));
                const penalty = calculateContributionPenalty(amount, daysDelayed);
                const totalOwed = amount + penalty;
                tableHTML += `
                    <tr><td style="padding: 0.4rem; border: 1px solid #1a73e8;">Days Delayed</td><td>${daysDelayed}</td></tr>
                    <tr><td style="padding: 0.4rem; border: 1px solid #1a73e8;">Penalty (KES)</td><td>${penalty.toFixed(2)}</td></tr>
                    <tr><td style="padding: 0.4rem; border: 1px solid #1a73e8; font-weight: bold;">Total Amount Owed (KES)</td><td style="font-weight: bold;">${totalOwed.toFixed(2)}</td></tr>
                `;
                tableHTML += '</table>';
                lastResult = { type, amount, totalOwed, daysDelayed, penalty, dueDate: elements.dueDate.value, month: elements.month.value };
                resultText += `Type: Deposit\nAmount: ${amount.toFixed(2)} KES\nDays Delayed: ${daysDelayed}\nPenalty: ${penalty.toFixed(2)} KES\nTotal Amount Owed: ${totalOwed.toFixed(2)} KES`;
                await submitContribution(amount, elements.month.value);
                saveCalculation(lastResult);
            } else if (type === 'existing_loan') {
                const dueDate = new Date(elements.dueDate.value + 'T00:00:00');
                const checkDate = new Date(elements.checkDate.value + 'T00:00:00');
                const daysDelayed = Math.max(0, Math.floor((checkDate - dueDate) / (24 * 60 * 60 * 1000)));
                const { totalOwed, interest, penalty, rollOverInterest } = calculateLoanOwed(amount, daysDelayed, elements.loanType.value);
                tableHTML += `
                    <tr><td style="padding: 0.4rem; border: 1px solid #1a73e8;">Days Delayed</td><td>${daysDelayed}</td></tr>
                    <tr><td style="padding: 0.4rem; border: 1px solid #1a73e8;">Initial Interest (KES)</td><td>${interest.toFixed(2)}</td></tr>
                    ${daysDelayed > 7 ? `
                        <tr><td style="padding: 0.4rem; border: 1px solid #1a73e8;">Roll-over Interest (KES)</td><td>${rollOverInterest.toFixed(2)}</td></tr>
                        <tr><td style="padding: 0.4rem; border: 1px solid #1a73e8;">Penalty (KES)</td><td>${penalty.toFixed(2)}</td></tr>
                    ` : ''}
                    <tr><td style="padding: 0.4rem; border: 1px solid #1a73e8; font-weight: bold;">Total Amount Owed (KES)</td><td style="font-weight: bold;">${totalOwed.toFixed(2)}</td></tr>
                `;
                tableHTML += '</table>';
                lastResult = { type, amount, totalOwed, daysDelayed, interest, penalty, rollOverInterest, dueDate: elements.dueDate.value, loanType: elements.loanType.value };
                resultText += `Type: Existing Loan\nAmount: ${amount.toFixed(2)} KES\nDays Delayed: ${daysDelayed}\nInitial Interest: ${interest.toFixed(2)} KES`;
                if (daysDelayed > 7) {
                    resultText += `\nRoll-over Interest: ${rollOverInterest.toFixed(2)} KES\nPenalty: ${penalty.toFixed(2)} KES`;
                }
                resultText += `\nTotal Amount Owed: ${totalOwed.toFixed(2)} KES`;
                saveCalculation(lastResult);
            } else if (type === 'apply_loan') {
                const repaymentPeriod = parseInt(elements.repaymentPeriod.value);
                const loanType = elements.loanType.value;
                const { totalOwed, interest, amortization, termMonths } = calculateApplyLoan(amount, loanType, repaymentPeriod);
                tableHTML += `
                    <tr><td style="padding: 0.4rem; border: 1px solid #1a73e8;">Interest (KES)</td><td>${interest.toFixed(2)}</td></tr>
                    <tr><td style="padding: 0.4rem; border: 1px solid #1a73e8; font-weight: bold;">Total Amount to Pay (KES)</td><td style="font-weight: bold;">${totalOwed.toFixed(2)}</td></tr>
                `;
                resultText += `Type: New Loans\nLoan Type: ${loanType.charAt(0).toUpperCase() + loanType.slice(1)} Term\nAmount: ${amount.toFixed(2)} KES\nInterest: ${interest.toFixed(2)} KES\nTotal Amount to Pay: ${totalOwed.toFixed(2)} KES\nRepayment Period: ${repaymentPeriod} months\n\nAmortization Schedule:\n`;
                if (amortization.length > 0) {
                    tableHTML += `
                        <tr><td colspan="2" style="padding: 0.4rem; border: 1px solid #1a73e8; font-weight: bold;">Amortization Schedule</td></tr>
                        <tr><td colspan="2">
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr style="background: linear-gradient(135deg, #1a73e8, #4285f4); color: #fff;">
                                    <th>Month</th><th>Payment (KES)</th><th>Interest (KES)</th><th>Principal (KES)</th><th>Balance (KES)</th>
                                </tr>
                    `;
                    amortization.forEach(row => {
                        tableHTML += `
                            <tr>
                                <td style="padding: 0.4rem; border: 1px solid #1a73e8;">${row.month}</td>
                                <td style="padding: 0.4rem; border: 1px solid #1a73e8;">${row.payment}</td>
                                <td style="padding: 0.4rem; border: 1px solid #1a73e8;">${row.interest}</td>
                                <td style="padding: 0.4rem; border: 1px solid #1a73e8;">${row.principal}</td>
                                <td style="padding: 0.4rem; border: 1px solid #1a73e8;">${row.balance}</td>
                            </tr>
                        `;
                        resultText += `Month ${row.month}: Payment ${row.payment} KES, Interest ${row.interest} KES, Principal ${row.principal} KES, Balance ${row.balance} KES\n`;
                    });
                    tableHTML += '</table></td></tr>';
                }
                tableHTML += '</table>';
                lastResult = { type, amount, totalOwed, interest, amortization, termMonths, repaymentPeriod, loanType };
                saveCalculation(lastResult);
            }
            lastResultText = resultText;

            if (window.innerHeight < 600) {
                elements.modalResult.innerHTML = tableHTML;
                elements.resultModal.style.display = 'flex';
            } else {
                elements.result.innerHTML = tableHTML;
                elements.resultModal.style.display = 'none';
            }

        } catch (error) {
            logError('Calculation failed', error);
            elements.result.innerHTML = `<span style="color: #e74c3c;">An error occurred during calculation: ${error.message}. Please try again.</span>`;
        } finally {
            resetButton();
            hideProgress();
        }
    }

    function resetButton() {
        isCalculating = false;
        elements.calcButton.classList.remove('loading');
        updateButtonState();
    }

    function closeResultModal() {
        elements.resultModal.style.display = 'none';
        elements.result.innerHTML = '';
    }

    function changeMainPage(direction) {
        currentMainPage += direction;
        if (currentMainPage < 1) currentMainPage = 1;
        if (currentMainPage > 4) currentMainPage = 4;
        for (let i = 1; i <= 4; i++) {
            document.getElementById(`page${i}`).style.display = i === currentMainPage ? 'block' : 'none';
        }
        document.getElementById('mainPageInfo').textContent = `Page ${currentMainPage} of 4`;
        document.getElementById('prevMainPage').disabled = currentMainPage === 1;
        document.getElementById('nextMainPage').disabled = currentMainPage === 4;
        if (currentMainPage === 2) {
            populateReportPeriods();
        } else if (currentMainPage === 3) {
            updateFinancialData();
        } else if (currentMainPage === 4) {
            populateBehaviorPeriods();
        }
        document.getElementById(`page${currentMainPage}`).focus();
    }

    function displayMembers(members) {
        const memberTableBody = document.getElementById('memberTableBody');
        memberTableBody.innerHTML = '';
        console.log('Members data:', members);

        // Hardcoded company members
        const hardcodedMembers = [
            { member_name: 'Enoch Kamau Thumbi', amount: 0, shares: 125, last_contribution_date: null },
            { member_name: 'John Waweru Njeri', amount: 0, shares: 125, last_contribution_date: null },
            { member_name: 'Geoffrey Mugi Gicini', amount: 0, shares: 125, last_contribution_date: null },
            { member_name: 'John Gatheru Iragu', amount: 0, shares: 125, last_contribution_date: null },
            { member_name: 'James Njoroge Kamau', amount: 0, shares: 125, last_contribution_date: null },
            { member_name: 'Joseph Wachira Waithaka', amount: 0, shares: 125, last_contribution_date: null },
            { member_name: 'Paul Masharia Muchiri', amount: 0, shares: 125, last_contribution_date: null },
            { member_name: 'Hempstone Mwangi Isaac', amount: 0, shares: 125, last_contribution_date: null },
            { member_name: 'Isaac Thuku Maina', amount: 0, shares: 0, last_contribution_date: null },
            { member_name: 'Nephat Njeru Muthee', amount: 0, shares: 0, last_contribution_date: null }
        ];

        // Merge API data with hardcoded members
        const combinedMembers = hardcodedMembers.map(hardcoded => {
            const apiMember = members.find(m => m.member_name === hardcoded.member_name);
            return {
                member_name: hardcoded.member_name,
                amount: apiMember ? apiMember.amount || 0 : 0,
                shares: hardcoded.shares,
                last_contribution_date: apiMember ? apiMember.last_contribution_date : null
            };
        });

        if (!combinedMembers || combinedMembers.length === 0) {
            memberTableBody.innerHTML = '<tr><td colspan="5">No members available.</td></tr>';
        } else {
            combinedMembers.forEach(member => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sanitizeInput(member.member_name || 'Unknown')}</td>
                    <td>KES ${(member.amount || 0).toFixed(2)}</td>
                    <td>${member.shares || 0}</td>
                    <td>${member.last_contribution_date ? new Date(member.last_contribution_date).toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' }) : 'N/A'}</td>
                    <td>KES ${(member.amount ? member.amount * 0.9 : 0).toFixed(2)}</td>
                `;
                memberTableBody.appendChild(row);
            });
        }
    }

    function updateFinancialData() {
        showSpinner(elements.spinners.balanceSheet);
        showSpinner(elements.spinners.members);
        fetchDataIfStale().then(data => {
            if (!data || (!data.monthly_reports && !data.member_contributions)) {
                console.warn('No data available in cache or API');
                if (currentMainPage === 2) {
                    document.getElementById('balanceSheetBody').innerHTML = `<tr><td colspan="2">No financial data available. Please submit data via admin panel.</td></tr>`;
                }
                if (currentMainPage === 3) {
                    document.getElementById('memberTableBody').innerHTML = `<tr><td colspan="5">No member data available. Please submit data via admin panel.</td></tr>`;
                }
                hideSpinner(elements.spinners.balanceSheet);
                hideSpinner(elements.spinners.members);
                return;
            }
            processFinancialData(data);
        }).catch(error => {
            logError('Error loading financial data', error);
            const errorMessage = `Failed to load data: ${error.message}. Please try again or contact support.`;
            if (currentMainPage === 2) {
                document.getElementById('balanceSheetBody').innerHTML = `<tr><td colspan="2">${errorMessage}</td></tr>`;
            }
            if (currentMainPage === 3) {
                document.getElementById('memberTableBody').innerHTML = `<tr><td colspan="5">${errorMessage}</td></tr>`;
            }
            hideSpinner(elements.spinners.balanceSheet);
            hideSpinner(elements.spinners.members);
        });
    }

    function processFinancialData(data) {
        console.log('Processing data for Page 2:', JSON.stringify(data, null, 2));
        currentMembers = data.member_contributions || [];
        if (currentMainPage === 3) {
            displayMembers(currentMembers);
        }

        const period = document.getElementById('reportPeriod').value;
        const periodValue = document.getElementById('reportMonth').value;
        let monthlyData = {};

        if (!data.monthly_reports || Object.keys(data.monthly_reports).length === 0) {
            console.log('No monthly_reports available');
            document.getElementById('balanceSheetBody').innerHTML = '<tr><td colspan="2">No financial data available. Please submit data via admin panel.</td></tr>';
            hideSpinner(elements.spinners.balanceSheet);
            hideSpinner(elements.spinners.members);
            return;
        }

        if (period === 'monthly' && periodValue) {
            monthlyData = data.monthly_reports[periodValue] || {};
        } else if (period === 'quarterly' && periodValue) {
            const [year, quarter] = periodValue.split('-Q');
            const quarterMonths = [];
            const startMonth = (parseInt(quarter) - 1) * 3 + 1;
            for (let i = 0; i < 3; i++) {
                const month = `${year}-${(startMonth + i).toString().padStart(2, '0')}`;
                if (data.monthly_reports[month]) quarterMonths.push(data.monthly_reports[month]);
            }
            monthlyData = quarterMonths.reduce((acc, curr) => ({
                opening_kcb_balance: (acc.opening_kcb_balance || 0) + (curr.opening_kcb_balance || 0),
                opening_lofty_balance: (acc.opening_lofty_balance || 0) + (curr.opening_lofty_balance || 0),
                total_member_contributions_kcb: (acc.total_member_contributions_kcb || 0) + (curr.total_member_contributions_kcb || 0),
                total_loan_repayments_kcb: (acc.total_loan_repayments_kcb || 0) + (curr.total_loan_repayments_kcb || 0),
                total_loan_repayments_lofty: (acc.total_loan_repayments_lofty || 0) + (curr.total_loan_repayments_lofty || 0),
                interest_on_loans_kcb: (acc.interest_on_loans_kcb || 0) + (curr.interest_on_loans_kcb || 0),
                interest_on_deposits_lofty: (acc.interest_on_deposits_lofty || 0) + (curr.interest_on_deposits_lofty || 0),
                other_income_kcb: (acc.other_income_kcb || 0) + (curr.other_income_kcb || 0),
                other_income_lofty: (acc.other_income_lofty || 0) + (curr.other_income_lofty || 0),
                total_loan_disbursements_kcb: (acc.total_loan_disbursements_kcb || 0) + (curr.total_loan_disbursements_kcb || 0),
                total_loan_disbursements_lofty: (acc.total_loan_disbursements_lofty || 0) + (curr.total_loan_disbursements_lofty || 0),
                bank_charges_kcb: (acc.bank_charges_kcb || 0) + (curr.bank_charges_kcb || 0),
                bank_charges_lofty: (acc.bank_charges_lofty || 0) + (curr.bank_charges_lofty || 0),
                petty_cash_utilized_kcb: (acc.petty_cash_utilized_kcb || 0) + (curr.petty_cash_utilized_kcb || 0),
                petty_cash_utilized_lofty: (acc.petty_cash_utilized_lofty || 0) + (curr.petty_cash_utilized_lofty || 0),
                agm_facilitation_kcb: (acc.agm_facilitation_kcb || 0) + (curr.agm_facilitation_kcb || 0),
                agm_facilitation_lofty: (acc.agm_facilitation_lofty || 0) + (curr.agm_facilitation_lofty || 0),
                welfare_kitty_utilized_kcb: (acc.welfare_kitty_utilized_kcb || 0) + (curr.welfare_kitty_utilized_kcb || 0),
                welfare_kitty_utilized_lofty: (acc.welfare_kitty_utilized_lofty || 0) + (curr.welfare_kitty_utilized_lofty || 0),
                other_expenses_kcb: (acc.other_expenses_kcb || 0) + (curr.other_expenses_kcb || 0),
                other_expenses_lofty: (acc.other_expenses_lofty || 0) + (curr.other_expenses_lofty || 0),
                total_inflows: (acc.total_inflows || 0) + (curr.total_inflows || 0),
                total_outflows: (acc.total_outflows || 0) + (curr.total_outflows || 0),
                kcb_balance: (acc.kcb_balance || 0) + (curr.kcb_balance || 0),
                lofty_balance: (acc.lofty_balance || 0) + (curr.lofty_balance || 0),
                total_balance: (acc.total_balance || 0) + (curr.total_balance || 0)
            }), {});
        } else if (period === 'yearly' && periodValue) {
            const yearMonths = Object.keys(data.monthly_reports).filter(m => m.startsWith(periodValue));
            monthlyData = yearMonths.reduce((acc, month) => {
                const curr = data.monthly_reports[month];
                return {
                    o```html
                    opening_kcb_balance: (acc.opening_kcb_balance || 0) + (curr.opening_kcb_balance || 0),
                    opening_lofty_balance: (acc.opening_lofty_balance || 0) + (curr.opening_lofty_balance || 0),
                    total_member_contributions_kcb: (acc.total_member_contributions_kcb || 0) + (curr.total_member_contributions_kcb || 0),
                    total_loan_repayments_kcb: (acc.total_loan_repayments_kcb || 0) + (curr.total_loan_repayments_kcb || 0),
                    total_loan_repayments_lofty: (acc.total_loan_repayments_lofty || 0) + (curr.total_loan_repayments_lofty || 0),
                    interest_on_loans_kcb: (acc.interest_on_loans_kcb || 0) + (curr.interest_on_loans_kcb || 0),
                    interest_on_deposits_lofty: (acc.interest_on_deposits_lofty || 0) + (curr.interest_on_deposits_lofty || 0),
                    other_income_kcb: (acc.other_income_kcb || 0) + (curr.other_income_kcb || 0),
                    other_income_lofty: (acc.other_income_lofty || 0) + (curr.other_income_lofty || 0),
                    total_loan_disbursements_kcb: (acc.total_loan_disbursements_kcb || 0) + (curr.total_loan_disbursements_kcb || 0),
                    total_loan_disbursements_lofty: (acc.total_loan_disbursements_lofty || 0) + (curr.total_loan_disbursements_lofty || 0),
                    bank_charges_kcb: (acc.bank_charges_kcb || 0) + (curr.bank_charges_kcb || 0),
                    bank_charges_lofty: (acc.bank_charges_lofty || 0) + (curr.bank_charges_lofty || 0),
                    petty_cash_utilized_kcb: (acc.petty_cash_utilized_kcb || 0) + (curr.petty_cash_utilized_kcb || 0),
                    petty_cash_utilized_lofty: (acc.petty_cash_utilized_lofty || 0) + (curr.petty_cash_utilized_lofty || 0),
                    agm_facilitation_kcb: (acc.agm_facilitation_kcb || 0) + (curr.agm_facilitation_kcb || 0),
                    agm_facilitation_lofty: (acc.agm_facilitation_lofty || 0) + (curr.agm_facilitation_lofty || 0),
                    welfare_kitty_utilized_kcb: (acc.welfare_kitty_utilized_kcb || 0) + (curr.welfare_kitty_utilized_kcb || 0),
                    welfare_kitty_utilized_lofty: (acc.welfare_kitty_utilized_lofty || 0) + (curr.welfare_kitty_utilized_lofty || 0),
                    other_expenses_kcb: (acc.other_expenses_kcb || 0) + (curr.other_expenses_kcb || 0),
                    other_expenses_lofty: (acc.other_expenses_lofty || 0) + (curr.other_expenses_lofty || 0),
                    total_inflows: (acc.total_inflows || 0) + (curr.total_inflows || 0),
                    total_outflows: (acc.total_outflows || 0) + (curr.total_outflows || 0),
                    kcb_balance: (acc.kcb_balance || 0) + (curr.kcb_balance || 0),
                    lofty_balance: (acc.lofty_balance || 0) + (curr.lofty_balance || 0),
                    total_balance: (acc.total_balance || 0) + (curr.total_balance || 0)
                };
            }, {});
        }

        if (currentMainPage === 2) {
            const balanceSheetBody = document.getElementById('balanceSheetBody');
            balanceSheetBody.innerHTML = '';

            if (!monthlyData || Object.keys(monthlyData).length === 0) {
                console.log('No data for selected period:', periodValue);
                balanceSheetBody.innerHTML = '<tr><td colspan="2">No financial data available for this period.</td></tr>';
                hideSpinner(elements.spinners.balanceSheet);
                return;
            }

            // Define financial items to display
            const financialItems = [
                { label: 'Opening KCB Balance', value: monthlyData.opening_kcb_balance || 0 },
                { label: 'Opening Lofty Balance', value: monthlyData.opening_lofty_balance || 0 },
                { label: 'Total Member Contributions (KCB)', value: monthlyData.total_member_contributions_kcb || 0 },
                { label: 'Total Loan Repayments (KCB)', value: monthlyData.total_loan_repayments_kcb || 0 },
                { label: 'Total Loan Repayments (Lofty)', value: monthlyData.total_loan_repayments_lofty || 0 },
                { label: 'Interest on Loans (KCB)', value: monthlyData.interest_on_loans_kcb || 0 },
                { label: 'Interest on Deposits (Lofty)', value: monthlyData.interest_on_deposits_lofty || 0 },
                { label: 'Other Income (KCB)', value: monthlyData.other_income_kcb || 0 },
                { label: 'Other Income (Lofty)', value: monthlyData.other_income_lofty || 0 },
                { label: 'Total Loan Disbursements (KCB)', value: monthlyData.total_loan_disbursements_kcb || 0 },
                { label: 'Total Loan Disbursements (Lofty)', value: monthlyData.total_loan_disbursements_lofty || 0 },
                { label: 'Bank Charges (KCB)', value: monthlyData.bank_charges_kcb || 0 },
                { label: 'Bank Charges (Lofty)', value: monthlyData.bank_charges_lofty || 0 },
                { label: 'Petty Cash Utilized (KCB)', value: monthlyData.petty_cash_utilized_kcb || 0 },
                { label: 'Petty Cash Utilized (Lofty)', value: monthlyData.petty_cash_utilized_lofty || 0 },
                { label: 'AGM Facilitation (KCB)', value: monthlyData.agm_facilitation_kcb || 0 },
                { label: 'AGM Facilitation (Lofty)', value: monthlyData.agm_facilitation_lofty || 0 },
                { label: 'Welfare Kitty Utilized (KCB)', value: monthlyData.welfare_kitty_utilized_kcb || 0 },
                { label: 'Welfare Kitty Utilized (Lofty)', value: monthlyData.welfare_kitty_utilized_lofty || 0 },
                { label: 'Other Expenses (KCB)', value: monthlyData.other_expenses_kcb || 0 },
                { label: 'Other Expenses (Lofty)', value: monthlyData.other_expenses_lofty || 0 },
                { label: 'Total Inflows', value: monthlyData.total_inflows || 0, bold: true },
                { label: 'Total Outflows', value: monthlyData.total_outflows || 0, bold: true },
                { label: 'KCB Balance', value: monthlyData.kcb_balance || 0, bold: true },
                { label: 'Lofty Balance', value: monthlyData.lofty_balance || 0, bold: true },
                { label: 'Total Balance', value: monthlyData.total_balance || 0, bold: true }
            ];

            financialItems.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="${item.bold ? 'font-weight: bold;' : ''} padding: 0.4rem; border: 1px solid #1a73e8;">${sanitizeInput(item.label)}</td>
                    <td style="${item.bold ? 'font-weight: bold;' : ''} padding: 0.4rem; border: 1px solid #1a73e8;">KES ${item.value.toFixed(2)}</td>
                `;
                balanceSheetBody.appendChild(row);
            });
        }

        hideSpinner(elements.spinners.balanceSheet);
        hideSpinner(elements.spinners.members);
    }

    function updateBehaviorReport() {
        const period = document.getElementById('behaviorPeriod').value;
        const periodValue = document.getElementById('behaviorMonth').value;
        const behaviorReportBody = document.getElementById('behaviorReportBody');
        behaviorReportBody.innerHTML = '';
        showSpinner(elements.spinners.behavior);

        fetchDataIfStale().then(data => {
            if (!data || !data.monthly_reports || Object.keys(data.monthly_reports).length === 0) {
                console.log('No monthly_reports data for behavior report:', data);
                behaviorReportBody.innerHTML = '<tr><td colspan="2">No report data available. Please submit data via admin panel.</td></tr>';
                hideSpinner(elements.spinners.behavior);
                return;
            }

            let reportData = {};
            if (period === 'monthly' && periodValue) {
                reportData = data.monthly_reports[periodValue] || {};
            } else if (period === 'quarterly' && periodValue) {
                const [year, quarter] = periodValue.split('-Q');
                const quarterMonths = [];
                const startMonth = (parseInt(quarter) - 1) * 3 + 1;
                for (let i = 0; i < 3; i++) {
                    const month = `${year}-${(startMonth + i).toString().padStart(2, '0')}`;
                    if (data.monthly_reports[month]) quarterMonths.push(data.monthly_reports[month]);
                }
                reportData = quarterMonths.reduce((acc, curr) => ({
                    total_inflows: (acc.total_inflows || 0) + (curr.total_inflows || 0),
                    total_outflows: (acc.total_outflows || 0) + (curr.total_outflows || 0),
                    kcb_balance: (acc.kcb_balance || 0) + (curr.kcb_balance || 0),
                    lofty_balance: (acc.lofty_balance || 0) + (curr.lofty_balance || 0),
                    total_balance: (acc.total_balance || 0) + (curr.total_balance || 0),
                    total_member_contributions_kcb: (acc.total_member_contributions_kcb || 0) + (curr.total_member_contributions_kcb || 0),
                    total_loan_disbursements_kcb: (acc.total_loan_disbursements_kcb || 0) + (curr.total_loan_disbursements_kcb || 0),
                    total_loan_disbursements_lofty: (acc.total_loan_disbursements_lofty || 0) + (curr.total_loan_disbursements_lofty || 0)
                }), {});
            } else if (period === 'yearly' && periodValue) {
                const yearMonths = Object.keys(data.monthly_reports).filter(m => m.startsWith(periodValue));
                reportData = yearMonths.reduce((acc, month) => {
                    const curr = data.monthly_reports[month];
                    return {
                        total_inflows: (acc.total_inflows || 0) + (curr.total_inflows || 0),
                        total_outflows: (acc.total_outflows || 0) + (curr.total_outflows || 0),
                        kcb_balance: (acc.kcb_balance || 0) + (curr.kcb_balance || 0),
                        lofty_balance: (acc.lofty_balance || 0) + (curr.lofty_balance || 0),
                        total_balance: (acc.total_balance || 0) + (curr.total_balance || 0),
                        total_member_contributions_kcb: (acc.total_member_contributions_kcb || 0) + (curr.total_member_contributions_kcb || 0),
                        total_loan_disbursements_kcb: (acc.total_loan_disbursements_kcb || 0) + (curr.total_loan_disbursements_kcb || 0),
                        total_loan_disbursements_lofty: (acc.total_loan_disbursements_lofty || 0) + (curr.total_loan_disbursements_lofty || 0)
                    };
                }, {});
            }

            if (!reportData || Object.keys(reportData).length === 0) {
                console.log('No data for selected behavior period:', periodValue);
                behaviorReportBody.innerHTML = '<tr><td colspan="2">No report data available for this period.</td></tr>';
                hideSpinner(elements.spinners.behavior);
                return;
            }

            // Calculate key metrics
            const net_cash_flow = (reportData.total_inflows || 0) - (reportData.total_outflows || 0);
            const loan_to_contribution_ratio = reportData.total_member_contributions_kcb ? 
                ((reportData.total_loan_disbursements_kcb || 0) + (reportData.total_loan_disbursements_lofty || 0)) / 
                reportData.total_member_contributions_kcb : 0;
            const liquidity_ratio = reportData.total_balance ? 
                (reportData.kcb_balance || 0 + reportData.lofty_balance || 0) / reportData.total_balance : 0;

            const behaviorItems = [
                { label: 'Total Inflows', value: reportData.total_inflows || 0, bold: true },
                { label: 'Total Outflows', value: reportData.total_outflows || 0, bold: true },
                { label: 'Net Cash Flow', value: net_cash_flow, bold: true },
                { label: 'KCB Balance', value: reportData.kcb_balance || 0 },
                { label: 'Lofty Balance', value: reportData.lofty_balance || 0 },
                { label: 'Total Balance', value: reportData.total_balance || 0, bold: true },
                { label: 'Total Member Contributions (KCB)', value: reportData.total_member_contributions_kcb || 0 },
                { label: 'Total Loan Disbursements (KCB + Lofty)', value: (reportData.total_loan_disbursements_kcb || 0) + (reportData.total_loan_disbursements_lofty || 0) },
                { label: 'Loan-to-Contribution Ratio', value: loan_to_contribution_ratio.toFixed(2), unit: '' },
                { label: 'Liquidity Ratio', value: liquidity_ratio.toFixed(2), unit: '' }
            ];

            console.log('Behavior report data:', behaviorItems);

            behaviorItems.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="${item.bold ? 'font-weight: bold;' : ''} padding: 0.4rem; border: 1px solid #1a73e8;">${sanitizeInput(item.label)}</td>
                    <td style="${item.bold ? 'font-weight: bold;' : ''} padding: 0.4rem; border: 1px solid #1a73e8;">${item.unit === '' ? item.value : `KES ${item.value.toFixed(2)}`}</td>
                `;
                behaviorReportBody.appendChild(row);
            });

            hideSpinner(elements.spinners.behavior);
        }).catch(error => {
            logError('Error loading behavior report', error);
            behaviorReportBody.innerHTML = `<tr><td colspan="2">Failed to load report: ${error.message}. Please try again or contact support.</td></tr>`;
            hideSpinner(elements.spinners.behavior);
        });
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
        toggleFields();
        populateYears();
        updateButtonState();
        debugDataStructure();
        if (currentMainPage === 2) {
            populateReportPeriods();
        } else if (currentMainPage === 3) {
            updateFinancialData();
        } else if (currentMainPage === 4) {
            populateBehaviorPeriods();
        }
    });

    // Handle input changes
    elements.amount.addEventListener('input', updateButtonState);
    elements.type.addEventListener('change', toggleFields);
    elements.loanType.addEventListener('change', toggleRepaymentFields);
    elements.repaymentPeriod.addEventListener('change', updateButtonState);
    elements.dueDate.addEventListener('change', updateButtonState);
    elements.checkDate.addEventListener('change', updateButtonState);
    elements.year.addEventListener('change', populateMonths);
    elements.month.addEventListener('change', updateDueDate);
    </script>
</body>
</html>
```
