<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="i-8 SMART BOT Admin: Update financial data and member contributions for the SACCO.">
    <meta name="author" content="Insightful Eight Co. Ltd.">
    <title>i-8 SMART BOT Admin</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231a73e8'%3E%3Cpath d='M19 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2zm-2 14H7v-2h10v2zm0-4H7v-2h10v2zm0-4H7V7h10v2z'/%3E%3C/svg%3E">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">i-8 SMART</div>
                <div class="logo-sub">Admin</div>
            </div>
            <nav class="sidebar-nav">
                <button class="sidebar-button" onclick="refreshForm()" aria-label="Refresh form and clear inputs">
                    <i class="fas fa-sync-alt"></i> Refresh Form
                </button>
                <button class="sidebar-button" onclick="downloadData()" aria-label="Download data backup">
                    <i class="fas fa-download"></i> Download Backup
                </button>
                <button class="sidebar-button logout-button" onclick="logout()" aria-label="Log out of admin panel">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </nav>
        </aside>
        <main class="main-content">
            <div class="card">
                <h2>Update Financial Data</h2>
                <div class="edit-controls">
                    <button class="action-button" onclick="loadBalanceSheetData()" aria-label="Load existing balance sheet data for editing">
                        <i class="fas fa-folder-open"></i> Load Balance Sheet
                        <span class="spinner-icon hidden"></span>
                    </button>
                    <select id="editBalanceYear" class="input-field" aria-label="Select year to edit balance sheet">
                        <option value="">Select Year</option>
                    </select>
                    <select id="editBalanceMonth" class="input-field" aria-label="Select month to edit balance sheet">
                        <option value="">Select Month to Edit</option>
                    </select>
                </div>
                <form id="adminForm" class="form-grid">
                    <div class="form-group">
                        <label for="balanceYear" class="tooltip" title="Select the year for which financial data is being entered or updated.">Select Year:</label>
                        <select id="balanceYear" class="input-field" aria-label="Select year for financial data" required>
                            <option value="">Select Year</option>
                        </select>
                        <span id="balanceYearError" class="error"></span>
                    </div>
                    <div class="form-group">
                        <label for="balanceMonth" class="tooltip" title="Select the month for which financial data is being entered or updated.">Select Month:</label>
                        <select id="balanceMonth" class="input-field" aria-label="Select month for financial data" required>
                            <option value="">Select Month</option>
                        </select>
                        <span id="balanceMonthError" class="error"></span>
                    </div>

                    <details class="collapsible-section">
                        <summary>KCB Accounts</summary>
                        <div class="form-group">
                            <label for="opening_kcb_balance" class="tooltip" title="The starting balance in the KCB account for the selected month (KES).">Opening KCB Balance (KES):</label>
                            <input type="number" id="opening_kcb_balance" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Opening KCB balance in KES">
                            <span id="openingKcbError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="total_member_contributions_kcb" class="tooltip" title="Total contributions made by members to the KCB account for the month (KES).">Members Contribution KCB (KES):</label>
                            <input type="number" id="total_member_contributions_kcb" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Members contribution KCB in KES">
                            <span id="membersContributionKcbError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="membership_fee_kcb" class="tooltip" title="Fees paid by new joining members to the KCB account for the month (KES).">Membership Fee KCB (KES):</label>
                            <input type="number" id="membership_fee_kcb" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Membership fee KCB in KES">
                            <span id="membershipFeeKcbError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="agm_payments_kcb" class="tooltip" title="Payments by members to facilitate AGM to the KCB account for the month (KES).">AGM Payments KCB (KES):</label>
                            <input type="number" id="agm_payments_kcb" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="AGM payments KCB in KES">
                            <span id="agmPaymentsKcbError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="penalties_charged_kcb" class="tooltip" title="Penalties charged to members for various offences to the KCB account for the month (KES).">Penalties Charged KCB (KES):</label>
                            <input type="number" id="penalties_charged_kcb" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Penalties charged KCB in KES">
                            <span id="penaltiesChargedKcbError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="total_loan_repayments_kcb" class="tooltip" title="Total loan repayments received in the KCB account for the month (KES).">Members Loan Repayment KCB (KES):</label>
                            <input type="number" id="total_loan_repayments_kcb" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Members loan repayment KCB in KES">
                            <span id="membersLoanRepaymentKcbError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="interest_on_loans_kcb" class="tooltip" title="Interest earned on loans issued from the KCB account for the month (KES).">Interest on Loans KCB (KES):</label>
                            <input type="number" id="interest_on_loans_kcb" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Interest on loans KCB in KES">
                            <span id="interestOnLoansKcbError" class="error"></span>
                        </div>
                        <!-- Custom Income Fields for KCB -->
                        <div class="form-group">
                            <label for="custom_income_1_kcb_name" class="tooltip" title="Name for custom income 1 in the KCB account (e.g., Sundry Income).">Custom Income 1 Name:</label>
                            <input type="text" id="custom_income_1_kcb_name" class="input-field" placeholder="Enter name (e.g., Sundry Income)" aria-label="Custom income 1 name for KCB">
                            <input type="number" id="custom_income_1_kcb" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Custom income 1 amount for KCB in KES">
                            <span id="customIncome1KcbError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="custom_income_2_kcb_name" class="tooltip" title="Name for custom income 2 in the KCB account.">Custom Income 2 Name:</label>
                            <input type="text" id="custom_income_2_kcb_name" class="input-field" placeholder="Enter name" aria-label="Custom income 2 name for KCB">
                            <input type="number" id="custom_income_2_kcb" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Custom income 2 amount for KCB in KES">
                            <span id="customIncome2KcbError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="custom_income_3_kcb_name" class="tooltip" title="Name for custom income 3 in the KCB account.">Custom Income 3 Name:</label>
                            <input type="text" id="custom_income_3_kcb_name" class="input-field" placeholder="Enter name" aria-label="Custom income 3 name for KCB">
                            <input type="number" id="custom_income_3_kcb" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Custom income 3 amount for KCB in KES">
                            <span id="customIncome3KcbError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="custom_income_4_kcb_name" class="tooltip" title="Name for custom income 4 in the KCB account.">Custom Income 4 Name:</label>
                            <input type="text" id="custom_income_4_kcb_name" class="input-field" placeholder="Enter name" aria-label="Custom income 4 name for KCB">
                            <input type="number" id="custom_income_4_kcb" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Custom income 4 amount for KCB in KES">
                            <span id="customIncome4KcbError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="custom_income_5_kcb_name" class="tooltip" title="Name for custom income 5 in the KCB account.">Custom Income 5 Name:</label>
                            <input type="text" id="custom_income_5_kcb_name" class="input-field" placeholder="Enter name" aria-label="Custom income 5 name for KCB">
                            <input type="number" id="custom_income_5_kcb" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Custom income 5 amount for KCB in KES">
                            <span id="customIncome5KcbError" class="error"></span>
                        </div>
                    </details>

                    <details class="collapsible-section">
                        <summary>Lofty Accounts</summary>
                        <div class="form-group">
                            <label for="opening_lofty_balance" class="tooltip" title="The starting balance in the Lofty account for the selected month (KES).">Opening Lofty Balance (KES):</label>
                            <input type="number" id="opening_lofty_balance" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Opening Lofty balance in KES">
                            <span id="openingLoftyError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="membership_fee_lofty" class="tooltip" title="Fees paid by new joining members to the Lofty account for the month (KES).">Membership Fee Lofty (KES):</label>
                            <input type="number" id="membership_fee_lofty" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Membership fee Lofty in KES">
                            <span id="membershipFeeLoftyError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="agm_payments_lofty" class="tooltip" title="Payments by members to facilitate AGM to the Lofty account for the month (KES).">AGM Payments Lofty (KES):</label>
                            <input type="number" id="agm_payments_lofty" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="AGM payments Lofty in KES">
                            <span id="agmPaymentsLoftyError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="penalties_charged_lofty" class="tooltip" title="Penalties charged to members for various offences to the Lofty account for the month (KES).">Penalties Charged Lofty (KES):</label>
                            <input type="number" id="penalties_charged_lofty" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Penalties charged Lofty in KES">
                            <span id="penaltiesChargedLoftyError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="total_loan_repayments_lofty" class="tooltip" title="Total loan repayments received in the Lofty account for the month (KES).">Members Loan Repayment Lofty (KES):</label>
                            <input type="number" id="total_loan_repayments_lofty" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Members loan repayment Lofty in KES">
                            <span id="membersLoanRepaymentLoftyError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="interest_on_deposits_lofty" class="tooltip" title="Interest earned on deposits held in the Lofty account for the month (KES).">Interest on Deposits Lofty (KES):</label>
                            <input type="number" id="interest_on_deposits_lofty" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Interest on deposits Lofty in KES">
                            <span id="interestOnDepositsLoftyError" class="error"></span>
                        </div>
                        <!-- Custom Income Fields for Lofty -->
                        <div class="form-group">
                            <label for="custom_income_1_lofty_name" class="tooltip" title="Name for custom income 1 in the Lofty account (e.g., Sundry Income).">Custom Income 1 Name:</label>
                            <input type="text" id="custom_income_1_lofty_name" class="input-field" placeholder="Enter name (e.g., Sundry Income)" aria-label="Custom income 1 name for Lofty">
                            <input type="number" id="custom_income_1_lofty" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Custom income 1 amount for Lofty in KES">
                            <span id="customIncome1LoftyError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="custom_income_2_lofty_name" class="tooltip" title="Name for custom income 2 in the Lofty account.">Custom Income 2 Name:</label>
                            <input type="text" id="custom_income_2_lofty_name" class="input-field" placeholder="Enter name" aria-label="Custom income 2 name for Lofty">
                            <input type="number" id="custom_income_2_lofty" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Custom income 2 amount for Lofty in KES">
                            <span id="customIncome2LoftyError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="custom_income_3_lofty_name" class="tooltip" title="Name for custom income 3 in the Lofty account.">Custom Income 3 Name:</label>
                            <input type="text" id="custom_income_3_lofty_name" class="input-field" placeholder="Enter name" aria-label="Custom income 3 name for Lofty">
                            <input type="number" id="custom_income_3_lofty" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Custom income 3 amount for Lofty in KES">
                            <span id="customIncome3LoftyError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="custom_income_4_lofty_name" class="tooltip" title="Name for custom income 4 in the Lofty account.">Custom Income 4 Name:</label>
                            <input type="text" id="custom_income_4_lofty_name" class="input-field" placeholder="Enter name" aria-label="Custom income 4 name for Lofty">
                            <input type="number" id="custom_income_4_lofty" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Custom income 4 amount for Lofty in KES">
                            <span id="customIncome4LoftyError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="custom_income_5_lofty_name" class="tooltip" title="Name for custom income 5 in the Lofty account.">Custom Income 5 Name:</label>
                            <input type="text" id="custom_income_5_lofty_name" class="input-field" placeholder="Enter name" aria-label="Custom income 5 name for Lofty">
                            <input type="number" id="custom_income_5_lofty" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Custom income 5 amount for Lofty in KES">
                            <span id="customIncome5LoftyError" class="error"></span>
                        </div>
                    </details>

                    <details class="collapsible-section">
                        <summary>Other Inflows</summary>
                        <div class="form-group">
                            <label for="other_income" class="tooltip" title="Miscellaneous income not categorized elsewhere, assigned to either KCB or Lofty account (KES).">Other Income (KES):</label>
                            <div class="input-group">
                                <select id="other_income_account" class="input-field" aria-label="Select account for other income">
                                    <option value="kcb">KCB</option>
                                    <option value="lofty">Lofty</option>
                                </select>
                                <input type="number" id="other_income" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Other income in KES">
                            </div>
                            <span id="otherIncomeError" class="error"></span>
                        </div>
                    </details>

                    <details class="collapsible-section">
                        <summary>Outflows</summary>
                        <div class="form-group">
                            <label for="total_loan_disbursements" class="tooltip" title="Total loans disbursed to members from either KCB or Lofty account for the month (KES).">Loans Advanced to Members (KES):</label>
                            <div class="input-group">
                                <select id="total_loan_disbursements_account" class="input-field" aria-label="Select account for loans advanced">
                                    <option value="kcb">KCB</option>
                                    <option value="lofty">Lofty</option>
                                </select>
                                <input type="number" id="total_loan_disbursements" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Loans advanced to members in KES">
                            </div>
                            <span id="loansAdvancedError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="bank_charges" class="tooltip" title="Charges incurred from banking services, assigned to either KCB or Lofty account (KES).">Bank Charges (KES):</label>
                            <div class="input-group">
                                <select id="bank_charges_account" class="input-field" aria-label="Select account for bank charges">
                                    <option value="kcb">KCB</option>
                                    <option value="lofty">Lofty</option>
                                </select>
                                <input type="number" id="bank_charges" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Bank charges in KES">
                            </div>
                            <span id="bankChargesError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="petty_cash_utilized" class="tooltip" title="Petty cash used for minor expenses, assigned to either KCB or Lofty account (KES).">Petty Cash Utilized (KES):</label>
                            <div class="input-group">
                                <select id="petty_cash_utilized_account" class="input-field" aria-label="Select account for petty cash utilized">
                                    <option value="kcb">KCB</option>
                                    <option value="lofty">Lofty</option>
                                </select>
                                <input type="number" id="petty_cash_utilized" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Petty cash utilized in KES">
                            </div>
                            <span id="pettyCashUtilizedError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="agm_facilitation" class="tooltip" title="Expenses related to facilitating the Annual General Meeting, assigned to either KCB or Lofty account (KES).">AGM Facilitation (KES):</label>
                            <div class="input-group">
                                <select id="agm_facilitation_account" class="input-field" aria-label="Select account for AGM facilitation">
                                    <option value="kcb">KCB</option>
                                    <option value="lofty">Lofty</option>
                                </select>
                                <input type="number" id="agm_facilitation" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="AGM facilitation in KES">
                            </div>
                            <span id="agmFacilitationError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="welfare_kitty_utilized" class="tooltip" title="Funds used for member welfare activities, assigned to either KCB or Lofty account (KES).">Welfare Kitty Utilized (KES):</label>
                            <div class="input-group">
                                <select id="welfare_kitty_utilized_account" class="input-field" aria-label="Select account for welfare kitty utilized">
                                    <option value="kcb">KCB</option>
                                    <option value="lofty">Lofty</option>
                                </select>
                                <input type="number" id="welfare_kitty_utilized" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Welfare kitty utilized in KES">
                            </div>
                            <span id="welfareKittyUtilizedError" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="other_expenses" class="tooltip" title="Miscellaneous expenses not categorized elsewhere, assigned to either KCB or Lofty account (KES).">Other Expenses (KES):</label>
                            <div class="input-group">
                                <select id="other_expenses_account" class="input-field" aria-label="Select account for other expenses">
                                    <option value="kcb">KCB</option>
                                    <option value="lofty">Lofty</option>
                                </select>
                                <input type="number" id="other_expenses" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Other expenses in KES">
                            </div>
                            <span id="otherExpensesError" class="error"></span>
                        </div>
                        <!-- Custom Outflow Fields for KCB and Lofty -->
                        <div class="form-group">
                            <label for="custom_outflow_1_name" class="tooltip" title="Name for custom outflow 1 (e.g., Operational Expense).">Custom Outflow 1 Name:</label>
                            <div class="input-group">
                                <select id="custom_outflow_1_account" class="input-field" aria-label="Select account for custom outflow 1">
                                    <option value="kcb">KCB</option>
                                    <option value="lofty">Lofty</option>
                                </select>
                                <input type="text" id="custom_outflow_1_name" class="input-field" placeholder="Enter name (e.g., Operational Expense)" aria-label="Custom outflow 1 name">
                                <input type="number" id="custom_outflow_1" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Custom outflow 1 amount in KES">
                            </div>
                            <span id="customOutflow1Error" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="custom_outflow_2_name" class="tooltip" title="Name for custom outflow 2.">Custom Outflow 2 Name:</label>
                            <div class="input-group">
                                <select id="custom_outflow_2_account" class="input-field" aria-label="Select account for custom outflow 2">
                                    <option value="kcb">KCB</option>
                                    <option value="lofty">Lofty</option>
                                </select>
                                <input type="text" id="custom_outflow_2_name" class="input-field" placeholder="Enter name" aria-label="Custom outflow 2 name">
                                <input type="number" id="custom_outflow_2" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Custom outflow 2 amount in KES">
                            </div>
                            <span id="customOutflow2Error" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="custom_outflow_3_name" class="tooltip" title="Name for custom outflow 3.">Custom Outflow 3 Name:</label>
                            <div class="input-group">
                                <select id="custom_outflow_3_account" class="input-field" aria-label="Select account for custom outflow 3">
                                    <option value="kcb">KCB</option>
                                    <option value="lofty">Lofty</option>
                                </select>
                                <input type="text" id="custom_outflow_3_name" class="input-field" placeholder="Enter name" aria-label="Custom outflow 3 name">
                                <input type="number" id="custom_outflow_3" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Custom outflow 3 amount in KES">
                            </div>
                            <span id="customOutflow3Error" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="custom_outflow_4_name" class="tooltip" title="Name for custom outflow 4.">Custom Outflow 4 Name:</label>
                            <div class="input-group">
                                <select id="custom_outflow_4_account" class="input-field" aria-label="Select account for custom outflow 4">
                                    <option value="kcb">KCB</option>
                                    <option value="lofty">Lofty</option>
                                </select>
                                <input type="text" id="custom_outflow_4_name" class="input-field" placeholder="Enter name" aria-label="Custom outflow 4 name">
                                <input type="number" id="custom_outflow_4" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Custom outflow 4 amount in KES">
                            </div>
                            <span id="customOutflow4Error" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="custom_outflow_5_name" class="tooltip" title="Name for custom outflow 5.">Custom Outflow 5 Name:</label>
                            <div class="input-group">
                                <select id="custom_outflow_5_account" class="input-field" aria-label="Select account for custom outflow 5">
                                    <option value="kcb">KCB</option>
                                    <option value="lofty">Lofty</option>
                                </select>
                                <input type="text" id="custom_outflow_5_name" class="input-field" placeholder="Enter name" aria-label="Custom outflow 5 name">
                                <input type="number" id="custom_outflow_5" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Custom outflow 5 amount in KES">
                            </div>
                            <span id="customOutflow5Error" class="error"></span>
                        </div>
                    </details>

                    <details class="collapsible-section">
                        <summary>Internal Account Transfers</summary>
                        <div class="form-group">
                            <label for="internal_transfer_amount" class="tooltip" title="Amount transferred between KCB and Lofty accounts (KES). Select direction of transfer.">Internal Account Transfer (KES):</label>
                            <div class="input-group">
                                <select id="internal_transfer_direction" class="input-field" aria-label="Select direction for internal account transfer">
                                    <option value="kcb_to_lofty">KCB to Lofty</option>
                                    <option value="lofty_to_kcb">Lofty to KCB</option>
                                </select>
                                <input type="number" id="internal_transfer_amount" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Internal account transfer amount in KES">
                            </div>
                            <span id="internalTransferError" class="error"></span>
                        </div>
                    </details>

                    <div class="button-container">
                        <button type="submit" id="submitFinancialButton" class="action-button primary" aria-label="Submit financial data">
                            <i class="fas fa-save"></i> Submit Financial Data
                            <span class="spinner-icon hidden"></span>
                        </button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>Update Member Contributions</h2>
                <div class="edit-controls">
                    <button class="action-button" onclick="loadContributionData()" aria-label="Load existing member contribution for editing">
                        <i class="fas fa-folder-open"></i> Load Contribution
                        <span class="spinner-icon hidden"></span>
                    </button>
                    <input type="text" id="editMember" class="input-field" placeholder="Enter member name" aria-label="Enter member name to edit contribution">
                    <span id="editMemberError" class="error"></span>
                    <select id="editContributionYear" class="input-field" aria-label="Select year to edit contribution">
                        <option value="">Select Year</option>
                    </select>
                    <select id="editContributionMonth" class="input-field" aria-label="Select month to edit contribution">
                        <option value="">Select Month</option>
                    </select>
                </div>
                <form id="memberContributionForm" class="form-grid">
                    <div class="form-group">
                        <label for="memberSelect" class="tooltip" title="Enter the full name of the member making the contribution.">Enter Member Name:</label>
                        <input type="text" id="memberSelect" class="input-field" placeholder="Enter member name" aria-label="Enter member name for contribution" required>
                        <span id="memberSelectError" class="error"></span>
                    </div>
                    <div class="form-group">
                        <label for="contributionYear" class="tooltip" title="Select the year for which the contribution is being recorded.">Select Year:</label>
                        <select id="contributionYear" class="input-field" aria-label="Select year for contribution" required>
                            <option value="">Select Year</option>
                        </select>
                        <span id="contributionYearError" class="error"></span>
                    </div>
                    <div class="form-group">
                        <label for="contributionMonth" class="tooltip" title="Select the month for which the contribution is being recorded.">Select Month:</label>
                        <select id="contributionMonth" class="input-field" aria-label="Select month for contribution" required>
                            <option value="">Select Month</option>
                        </select>
                        <span id="contributionMonthError" class="error"></span>
                    </div>
                    <div class="form-group">
                        <label for="dueDate" class="tooltip" title="Calculated due date for the contribution (10th of the following month).">Due Date:</label>
                        <input type="text" id="dueDate" class="input-field" readonly aria-label="Due date for contribution">
                        <span id="dueDateError" class="error"></span>
                    </div>
                    <div class="form-group">
                        <label for="contributionAmount" class="tooltip" title="The amount contributed by the member for the selected month (KES).">Contribution Amount (KES):</label>
                        <input type="number" id="contributionAmount" class="input-field" min="0" step="0.01" placeholder="Enter amount" aria-label="Member contribution amount in KES" required>
                        <span id="contributionAmountError" class="error"></span>
                    </div>
                    <div class="button-container">
                        <button type="submit" id="submitContributionButton" class="action-button primary" aria-label="Submit member contribution">
                            <i class="fas fa-save"></i> Submit Contribution
                            <span class="spinner-icon hidden"></span>
                        </button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>Admin Logs</h2>
                <div id="adminLogs" class="log-section"></div>
            </div>

            <div id="result" class="result"></div>
        </main>

        <!-- Confirmation Modal -->
        <div id="confirmationModal" class="modal">
            <div class="modal-content">
                <h3>Confirm Financial Data Submission</h3>
                <p>Please review the entered data before submitting:</p>
                <div id="modalSummary" class="modal-summary"></div>
                <div class="modal-buttons">
                    <button id="confirmSubmit" class="action-button primary" aria-label="Confirm submission">
                        <i class="fas fa-check"></i> Confirm
                        <span class="spinner-icon hidden"></span>
                    </button>
                    <button id="cancelSubmit" class="action-button secondary" aria-label="Cancel submission">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="spinner">
            <div class="spinner-icon"></div>
            <p>Processing...</p>
        </div>
    </div>

    <script>
        const MEMBERS = [
            "Enoch Kamau Thumbi",
            "John Waweru Njeri",
            "Geoffrey Mugi Gicini",
            "John Gatheru Iragu",
            "James Njoroge Kamau",
            "Joseph Wachira Waithaka",
            "Paul Masharia Muchiri",
            "Hempstone Mwangi Isaac",
            "Isaac Thuku Maina",
            "Nephat Njeru Muthee"
        ];

        const CONFIG = {
            API_BASE_URL: 'https://i8-smart-backend.onrender.com/api',
            API_KEY: 'i8-smart-backend-2025',
            FETCH_TIMEOUT: 10000
        };

        // Input sanitization and validation utilities
        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input.replace(/[<>\"'&]/g, '').trim();
        }

        function sanitizeNumericInput(input) {
            if (typeof input !== 'string') return '';
            return input.replace(/[^0-9.-]/g, '');
        }

        function isValidNumber(value) {
            const num = parseFloat(value);
            return !isNaN(num) && isFinite(num);
        }

        function safeGetElementById(id) {
            try {
                const element = document.getElementById(id);
                if (!element) {
                    console.error(`Element with ID '${id}' not found`);
                    return null;
                }
                return element;
            } catch (error) {
                console.error(`Error getting element with ID '${id}':`, error);
                return null;
            }
        }

        function setButtonLoading(button, isLoading) {
            const spinner = button.querySelector('.spinner-icon');
            if (isLoading) {
                button.disabled = true;
                spinner.classList.remove('hidden');
                button.style.opacity = '0.7';
            } else {
                button.disabled = false;
                spinner.classList.add('hidden');
                button.style.opacity = '1';
            }
        }

        function populateYears(selectId) {
            try {
                const yearSelect = document.getElementById(selectId);
                if (!yearSelect) {
                    console.error(`Element with ID ${selectId} not found.`);
                    document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">Error: Year selector (${selectId}) not found. Please refresh the page.</span>`;
                    return;
                }
                yearSelect.innerHTML = '<option value="">Select Year</option>';
                const currentYear = new Date().getFullYear();
                for (let year = 2024; year <= currentYear + 1; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.text = year;
                    yearSelect.appendChild(option);
                }
                console.log(`Populated years for ${selectId}`);
            } catch (error) {
                console.error(`Error populating years for ${selectId}:`, error);
                document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">Error: Failed to populate years for ${selectId}. Please refresh the page.</span>`;
            }
        }

        function populateMonths(selectId, year) {
            try {
                const monthSelect = document.getElementById(selectId);
                if (!monthSelect) {
                    console.error(`Element with ID ${selectId} not found.`);
                    document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">Error: Month selector (${selectId}) not found. Please refresh the page.</span>`;
                    return;
                }
                monthSelect.innerHTML = '<option value="">Select Month</option>';
                if (!year) {
                    console.log(`No year selected for ${selectId}, clearing months.`);
                    return;
                }
                const monthAbbr = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                for (let month = 0; month < 12; month++) {
                    const monthValue = `${year}-${(month + 1).toString().padStart(2, '0')}`;
                    const option = document.createElement('option');
                    option.value = monthValue;
                    option.text = `${monthAbbr[month]} ${year}`;
                    monthSelect.appendChild(option);
                }
                console.log(`Populated months for ${selectId} with year ${year}`);
            } catch (error) {
                console.error(`Error populating months for ${selectId}:`, error);
                document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">Error: Failed to populate months for ${selectId}. Please refresh the page.</span>`;
            }
        }

        function calculateDueDate(monthStr) {
            if (!monthStr) return '';
            const [year, monthStrNum] = monthStr.split('-');
            let m = parseInt(monthStrNum, 10);
            let nextY = parseInt(year, 10);
            let nextM = m + 1;
            if (nextM > 12) {
                nextM = 1;
                nextY += 1;
            }
            const dueDate = new Date(nextY, nextM - 1, 10); // 0-indexed month
            return dueDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function updateDueDate() {
            const monthSelect = document.getElementById('contributionMonth');
            const dueDateInput = document.getElementById('dueDate');
            const dueDateError = document.getElementById('dueDateError');
            if (monthSelect && dueDateInput && dueDateError) {
                const monthStr = monthSelect.value;
                const dueDate = calculateDueDate(monthStr);
                dueDateInput.value = dueDate;
                dueDateError.style.display = 'none';
                dueDateError.textContent = '';
            }
        }

        function fuzzyMatch(input, members) {
            const cleanInput = input.trim().toLowerCase();
            if (!cleanInput) return null;
            const inputParts = cleanInput.split(/\s+/).filter(part => part.length > 0);
            if (inputParts.length < 2) return null;
            for (const member of members) {
                const memberParts = member.toLowerCase().split(/\s+/);
                let matchCount = 0;
                for (const inputPart of inputParts) {
                    if (memberParts.some(memberPart => memberPart.includes(inputPart))) {
                        matchCount++;
                    }
                }
                if (matchCount >= 2) return member;
            }
            return null;
        }

        function validateFinancialInputs() {
            const errors = [];
            const inputs = [
                { id: 'balanceYear', errorId: 'balanceYearError', message: 'Please select a year.' },
                { id: 'balanceMonth', errorId: 'balanceMonthError', message: 'Please select a month.' },
                { id: 'opening_kcb_balance', errorId: 'openingKcbError', message: 'Please enter a valid KCB balance.' },
                { id: 'opening_lofty_balance', errorId: 'openingLoftyError', message: 'Please enter a valid Lofty balance.' },
                { id: 'total_member_contributions_kcb', errorId: 'membersContributionKcbError', message: 'Please enter a valid contribution amount.' },
                { id: 'membership_fee_kcb', errorId: 'membershipFeeKcbError', message: 'Please enter a valid membership fee for KCB.' },
                { id: 'membership_fee_lofty', errorId: 'membershipFeeLoftyError', message: 'Please enter a valid membership fee for Lofty.' },
                { id: 'agm_payments_kcb', errorId: 'agmPaymentsKcbError', message: 'Please enter a valid AGM payments for KCB.' },
                { id: 'agm_payments_lofty', errorId: 'agmPaymentsLoftyError', message: 'Please enter a valid AGM payments for Lofty.' },
                { id: 'penalties_charged_kcb', errorId: 'penaltiesChargedKcbError', message: 'Please enter a valid penalties charged for KCB.' },
                { id: 'penalties_charged_lofty', errorId: 'penaltiesChargedLoftyError', message: 'Please enter a valid penalties charged for Lofty.' },
                { id: 'total_loan_repayments_kcb', errorId: 'membersLoanRepaymentKcbError', message: 'Please enter a valid repayment amount for KCB.' },
                { id: 'total_loan_repayments_lofty', errorId: 'membersLoanRepaymentLoftyError', message: 'Please enter a valid repayment amount for Lofty.' },
                { id: 'interest_on_loans_kcb', errorId: 'interestOnLoansKcbError', message: 'Please enter a valid interest amount for KCB.' },
                { id: 'interest_on_deposits_lofty', errorId: 'interestOnDepositsLoftyError', message: 'Please enter a valid interest amount for Lofty.' },
                { id: 'other_income', errorId: 'otherIncomeError', message: 'Please enter a valid other income amount.' },
                { id: 'total_loan_disbursements', errorId: 'loansAdvancedError', message: 'Please enter a valid loans advanced amount.' },
                { id: 'bank_charges', errorId: 'bankChargesError', message: 'Please enter a valid bank charges amount.' },
                { id: 'petty_cash_utilized', errorId: 'pettyCashUtilizedError', message: 'Please enter a valid petty cash amount.' },
                { id: 'agm_facilitation', errorId: 'agmFacilitationError', message: 'Please enter a valid AGM facilitation amount.' },
                { id: 'welfare_kitty_utilized', errorId: 'welfareKittyUtilizedError', message: 'Please enter a valid welfare kitty amount.' },
                { id: 'other_expenses', errorId: 'otherExpensesError', message: 'Please enter a valid other expenses amount.' },
                { id: 'custom_income_1_kcb', errorId: 'customIncome1KcbError', message: 'Please enter a valid amount for Custom Income 1 (KCB) or ensure the name is filled.' },
                { id: 'custom_income_2_kcb', errorId: 'customIncome2KcbError', message: 'Please enter a valid amount for Custom Income 2 (KCB) or ensure the name is filled.' },
                { id: 'custom_income_3_kcb', errorId: 'customIncome3KcbError', message: 'Please enter a valid amount for Custom Income 3 (KCB) or ensure the name is filled.' },
                { id: 'custom_income_4_kcb', errorId: 'customIncome4KcbError', message: 'Please enter a valid amount for Custom Income 4 (KCB) or ensure the name is filled.' },
                { id: 'custom_income_5_kcb', errorId: 'customIncome5KcbError', message: 'Please enter a valid amount for Custom Income 5 (KCB) or ensure the name is filled.' },
                { id: 'custom_income_1_lofty', errorId: 'customIncome1LoftyError', message: 'Please enter a valid amount for Custom Income 1 (Lofty) or ensure the name is filled.' },
                { id: 'custom_income_2_lofty', errorId: 'customIncome2LoftyError', message: 'Please enter a valid amount for Custom Income 2 (Lofty) or ensure the name is filled.' },
                { id: 'custom_income_3_lofty', errorId: 'customIncome3LoftyError', message: 'Please enter a valid amount for Custom Income 3 (Lofty) or ensure the name is filled.' },
                { id: 'custom_income_4_lofty', errorId: 'customIncome4LoftyError', message: 'Please enter a valid amount for Custom Income 4 (Lofty) or ensure the name is filled.' },
                { id: 'custom_income_5_lofty', errorId: 'customIncome5LoftyError', message: 'Please enter a valid amount for Custom Income 5 (Lofty) or ensure the name is filled.' },
                { id: 'custom_outflow_1', errorId: 'customOutflow1Error', message: 'Please enter a valid amount for Custom Outflow 1 or ensure the name is filled.' },
                { id: 'custom_outflow_2', errorId: 'customOutflow2Error', message: 'Please enter a valid amount for Custom Outflow 2 or ensure the name is filled.' },
                { id: 'custom_outflow_3', errorId: 'customOutflow3Error', message: 'Please enter a valid amount for Custom Outflow 3 or ensure the name is filled.' },
                { id: 'custom_outflow_4', errorId: 'customOutflow4Error', message: 'Please enter a valid amount for Custom Outflow 4 or ensure the name is filled.' },
                { id: 'custom_outflow_5', errorId: 'customOutflow5Error', message: 'Please enter a valid amount for Custom Outflow 5 or ensure the name is filled.' },
                { id: 'internal_transfer_amount', errorId: 'internalTransferError', message: 'Please enter a valid internal transfer amount.' }
            ];

            inputs.forEach(input => {
                const element = document.getElementById(input.id);
                const errorElement = document.getElementById(input.errorId);
                if (!element || !errorElement) {
                    console.error(`DOM element not found: ${input.id} or ${input.errorId}`);
                    return;
                }
                errorElement.style.display = 'none';
                if (input.id === 'balanceYear' || input.id === 'balanceMonth') {
                    if (!element.value) {
                        errorElement.textContent = input.message;
                        errorElement.style.display = 'block';
                        errors.push(input.message);
                    }
                } else if (input.id.includes('custom_income') || input.id.includes('custom_outflow')) {
                    const nameElement = document.getElementById(`${input.id}_name`);
                    const value = parseFloat(element.value);
                    if ((element.value.trim() || nameElement.value.trim()) && (!isValidNumber(value) || value < 0 || !nameElement.value.trim())) {
                        errorElement.textContent = input.message;
                        errorElement.style.display = 'block';
                        errors.push(input.message);
                    }
                } else {
                    const value = parseFloat(element.value);
                    if (element.value.trim() && (!isValidNumber(value) || value < 0)) {
                        errorElement.textContent = input.message;
                        errorElement.style.display = 'block';
                        errors.push(input.message);
                    }
                }
            });
            return errors.length === 0 ? null : errors.join(', ');
        }

        function validateContributionInputs() {
            const errors = [];
            const inputs = [
                { id: 'memberSelect', errorId: 'memberSelectError', message: 'Please enter a valid member name (at least two name parts required).' },
                { id: 'contributionYear', errorId: 'contributionYearError', message: 'Please select a year.' },
                { id: 'contributionMonth', errorId: 'contributionMonthError', message: 'Please select a month.' },
                { id: 'dueDate', errorId: 'dueDateError', message: 'Due date could not be calculated. Please select a valid month.' },
                { id: 'contributionAmount', errorId: 'contributionAmountError', message: 'Please enter a valid contribution amount.' }
            ];

            inputs.forEach(input => {
                const element = document.getElementById(input.id);
                const errorElement = document.getElementById(input.errorId);
                if (!element || !errorElement) {
                    console.error(`DOM element not found: ${input.id} or ${input.errorId}`);
                    return;
                }
                errorElement.style.display = 'none';
                if (input.id === 'memberSelect') {
                    if (!element.value.trim() || !fuzzyMatch(element.value, MEMBERS)) {
                        errorElement.textContent = input.message;
                        errorElement.style.display = 'block';
                        errors.push(input.message);
                    }
                } else if (input.id === 'contributionYear' || input.id === 'contributionMonth') {
                    if (!element.value) {
                        errorElement.textContent = input.message;
                        errorElement.style.display = 'block';
                        errors.push(input.message);
                    }
                } else if (input.id === 'dueDate') {
                    if (!element.value.trim()) {
                        errorElement.textContent = input.message;
                        errorElement.style.display = 'block';
                        errors.push(input.message);
                    }
                } else if (input.id === 'contributionAmount') {
                    const value = parseFloat(element.value);
                    if (!element.value.trim() || isNaN(value) || value <= 0) {
                        errorElement.textContent = input.message;
                        errorElement.style.display = 'block';
                        errors.push(input.message);
                    }
                }
            });
            return errors.length === 0 ? null : errors.join(', ');
        }

        function logAction(action, details) {
            const logs = JSON.parse(localStorage.getItem('adminLogs') || '[]');
            logs.push({ timestamp: new Date().toISOString(), action, details });
            localStorage.setItem('adminLogs', JSON.stringify(logs));
            displayLogs();
        }

        function displayLogs() {
            const logs = JSON.parse(localStorage.getItem('adminLogs') || '[]');
            const logSection = document.getElementById('adminLogs');
            logSection.innerHTML = logs.length > 0 ? `
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Action</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${logs.map(log => `
                            <tr>
                                <td>${new Date(log.timestamp).toLocaleString('en-GB')}</td>
                                <td>${log.action}</td>
                                <td>${log.details}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p>No logs available.</p>';
        }

        function showLoadingSpinner() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.style.display = 'flex';
        }

        function hideLoadingSpinner() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.style.display = 'none';
        }

        function showConfirmationModal(data, month, onConfirm) {
            const modal = document.getElementById('confirmationModal');
            const modalSummary = document.getElementById('modalSummary');
            let summaryHTML = `
                <p><strong>Month:</strong> ${month}</p>
                <h4>KCB Accounts</h4>
                ${data.opening_kcb_balance > 0 ? `<p>Opening KCB Balance: KES ${data.opening_kcb_balance.toFixed(2)}</p>` : ''}
                ${data.total_member_contributions_kcb > 0 ? `<p>Members Contribution KCB: KES ${data.total_member_contributions_kcb.toFixed(2)}</p>` : ''}
                ${data.membership_fee_kcb > 0 ? `<p>Membership Fee KCB: KES ${data.membership_fee_kcb.toFixed(2)}</p>` : ''}
                ${data.agm_payments_kcb > 0 ? `<p>AGM Payments KCB: KES ${data.agm_payments_kcb.toFixed(2)}</p>` : ''}
                ${data.penalties_charged_kcb > 0 ? `<p>Penalties Charged KCB: KES ${data.penalties_charged_kcb.toFixed(2)}</p>` : ''}
                ${data.total_loan_repayments_kcb > 0 ? `<p>Loan Repayments KCB: KES ${data.total_loan_repayments_kcb.toFixed(2)}</p>` : ''}
                ${data.interest_on_loans_kcb > 0 ? `<p>Interest on Loans KCB: KES ${data.interest_on_loans_kcb.toFixed(2)}</p>` : ''}
                ${data.custom_income_1_kcb > 0 && data.custom_income_1_kcb_name ? `<p>${data.custom_income_1_kcb_name}: KES ${data.custom_income_1_kcb.toFixed(2)}</p>` : ''}
                ${data.custom_income_2_kcb > 0 && data.custom_income_2_kcb_name ? `<p>${data.custom_income_2_kcb_name}: KES ${data.custom_income_2_kcb.toFixed(2)}</p>` : ''}
                ${data.custom_income_3_kcb > 0 && data.custom_income_3_kcb_name ? `<p>${data.custom_income_3_kcb_name}: KES ${data.custom_income_3_kcb.toFixed(2)}</p>` : ''}
                ${data.custom_income_4_kcb > 0 && data.custom_income_4_kcb_name ? `<p>${data.custom_income_4_kcb_name}: KES ${data.custom_income_4_kcb.toFixed(2)}</p>` : ''}
                ${data.custom_income_5_kcb > 0 && data.custom_income_5_kcb_name ? `<p>${data.custom_income_5_kcb_name}: KES ${data.custom_income_5_kcb.toFixed(2)}</p>` : ''}
                <h4>Lofty Accounts</h4>
                ${data.opening_lofty_balance > 0 ? `<p>Opening Lofty Balance: KES ${data.opening_lofty_balance.toFixed(2)}</p>` : ''}
                ${data.membership_fee_lofty > 0 ? `<p>Membership Fee Lofty: KES ${data.membership_fee_lofty.toFixed(2)}</p>` : ''}
                ${data.agm_payments_lofty > 0 ? `<p>AGM Payments Lofty: KES ${data.agm_payments_lofty.toFixed(2)}</p>` : ''}
                ${data.penalties_charged_lofty > 0 ? `<p>Penalties Charged Lofty: KES ${data.penalties_charged_lofty.toFixed(2)}</p>` : ''}
                ${data.total_loan_repayments_lofty > 0 ? `<p>Loan Repayments Lofty: KES ${data.total_loan_repayments_lofty.toFixed(2)}</p>` : ''}
                ${data.interest_on_deposits_lofty > 0 ? `<p>Interest on Deposits Lofty: KES ${data.interest_on_deposits_lofty.toFixed(2)}</p>` : ''}
                ${data.custom_income_1_lofty > 0 && data.custom_income_1_lofty_name ? `<p>${data.custom_income_1_lofty_name}: KES ${data.custom_income_1_lofty.toFixed(2)}</p>` : ''}
                ${data.custom_income_2_lofty > 0 && data.custom_income_2_lofty_name ? `<p>${data.custom_income_2_lofty_name}: KES ${data.custom_income_2_lofty.toFixed(2)}</p>` : ''}
                ${data.custom_income_3_lofty > 0 && data.custom_income_3_lofty_name ? `<p>${data.custom_income_3_lofty_name}: KES ${data.custom_income_3_lofty.toFixed(2)}</p>` : ''}
                ${data.custom_income_4_lofty > 0 && data.custom_income_4_lofty_name ? `<p>${data.custom_income_4_lofty_name}: KES ${data.custom_income_4_lofty.toFixed(2)}</p>` : ''}
                ${data.custom_income_5_lofty > 0 && data.custom_income_5_lofty_name ? `<p>${data.custom_income_5_lofty_name}: KES ${data.custom_income_5_lofty.toFixed(2)}</p>` : ''}
                <h4>Other Inflows</h4>
                ${(data.other_income_kcb > 0 || data.other_income_lofty > 0) ? `<p>Other Income (${data.other_income_kcb > 0 ? 'KCB' : 'Lofty'}): KES ${(data.other_income_kcb + data.other_income_lofty).toFixed(2)}</p>` : ''}
                <h4>Outflows</h4>
                ${(data.total_loan_disbursements_kcb > 0 || data.total_loan_disbursements_lofty > 0) ? `<p>Loan Disbursements (${data.total_loan_disbursements_kcb > 0 ? 'KCB' : 'Lofty'}): KES ${(data.total_loan_disbursements_kcb + data.total_loan_disbursements_lofty).toFixed(2)}</p>` : ''}
                ${(data.bank_charges_kcb > 0 || data.bank_charges_lofty > 0) ? `<p>Bank Charges (${data.bank_charges_kcb > 0 ? 'KCB' : 'Lofty'}): KES ${(data.bank_charges_kcb + data.bank_charges_lofty).toFixed(2)}</p>` : ''}
                ${(data.petty_cash_utilized_kcb > 0 || data.petty_cash_utilized_lofty > 0) ? `<p>Petty Cash Utilized (${data.petty_cash_utilized_kcb > 0 ? 'KCB' : 'Lofty'}): KES ${(data.petty_cash_utilized_kcb + data.petty_cash_utilized_lofty).toFixed(2)}</p>` : ''}
                ${(data.agm_facilitation_kcb > 0 || data.agm_facilitation_lofty > 0) ? `<p>AGM Facilitation (${data.agm_facilitation_kcb > 0 ? 'KCB' : 'Lofty'}): KES ${(data.agm_facilitation_kcb + data.agm_facilitation_lofty).toFixed(2)}</p>` : ''}
                ${(data.welfare_kitty_utilized_kcb > 0 || data.welfare_kitty_utilized_lofty > 0) ? `<p>Welfare Kitty Utilized (${data.welfare_kitty_utilized_kcb > 0 ? 'KCB' : 'Lofty'}): KES ${(data.welfare_kitty_utilized_kcb + data.welfare_kitty_utilized_lofty).toFixed(2)}</p>` : ''}
                ${(data.other_expenses_kcb > 0 || data.other_expenses_lofty > 0) ? `<p>Other Expenses (${data.other_expenses_kcb > 0 ? 'KCB' : 'Lofty'}): KES ${(data.other_expenses_kcb + data.other_expenses_lofty).toFixed(2)}</p>` : ''}
                ${data.custom_outflow_1_kcb > 0 && data.custom_outflow_1_name ? `<p>${data.custom_outflow_1_name} (KCB): KES ${data.custom_outflow_1_kcb.toFixed(2)}</p>` : ''}
                ${data.custom_outflow_1_lofty > 0 && data.custom_outflow_1_name ? `<p>${data.custom_outflow_1_name} (Lofty): KES ${data.custom_outflow_1_lofty.toFixed(2)}</p>` : ''}
                ${data.custom_outflow_2_kcb > 0 && data.custom_outflow_2_name ? `<p>${data.custom_outflow_2_name} (KCB): KES ${data.custom_outflow_2_kcb.toFixed(2)}</p>` : ''}
                ${data.custom_outflow_2_lofty > 0 && data.custom_outflow_2_name ? `<p>${data.custom_outflow_2_name} (Lofty): KES ${data.custom_outflow_2_lofty.toFixed(2)}</p>` : ''}
                ${data.custom_outflow_3_kcb > 0 && data.custom_outflow_3_name ? `<p>${data.custom_outflow_3_name} (KCB): KES ${data.custom_outflow_3_kcb.toFixed(2)}</p>` : ''}
                ${data.custom_outflow_3_lofty > 0 && data.custom_outflow_3_name ? `<p>${data.custom_outflow_3_name} (Lofty): KES ${data.custom_outflow_3_lofty.toFixed(2)}</p>` : ''}
                ${data.custom_outflow_4_kcb > 0 && data.custom_outflow_4_name ? `<p>${data.custom_outflow_4_name} (KCB): KES ${data.custom_outflow_4_kcb.toFixed(2)}</p>` : ''}
                ${data.custom_outflow_4_lofty > 0 && data.custom_outflow_4_name ? `<p>${data.custom_outflow_4_name} (Lofty): KES ${data.custom_outflow_4_lofty.toFixed(2)}</p>` : ''}
                ${data.custom_outflow_5_kcb > 0 && data.custom_outflow_5_name ? `<p>${data.custom_outflow_5_name} (KCB): KES ${data.custom_outflow_5_kcb.toFixed(2)}</p>` : ''}
                ${data.custom_outflow_5_lofty > 0 && data.custom_outflow_5_name ? `<p>${data.custom_outflow_5_name} (Lofty): KES ${data.custom_outflow_5_lofty.toFixed(2)}</p>` : ''}
                <h4>Internal Account Transfers</h4>
                ${data.internal_transfer_amount > 0 ? `<p>Internal Transfer (${data.internal_transfer_direction === 'kcb_to_lofty' ? 'KCB to Lofty' : 'Lofty to KCB'}): KES ${data.internal_transfer_amount.toFixed(2)}</p>` : ''}
                <h4>Summary</h4>
                <p>Total Inflows: KES ${data.total_inflows.toFixed(2)}</p>
                <p>Total Outflows: KES ${data.total_outflows.toFixed(2)}</p>
                <p>KCB Balance: KES ${data.kcb_balance.toFixed(2)}</p>
                <p>Lofty Balance: KES ${data.lofty_balance.toFixed(2)}</p>
                <p>Total Balance: KES ${data.total_balance.toFixed(2)}</p>
            `;
            modalSummary.innerHTML = summaryHTML;
            modal.style.display = 'block';
            document.getElementById('confirmSubmit').onclick = () => {
                setButtonLoading(document.getElementById('confirmSubmit'), true);
                modal.style.display = 'none';
                onConfirm();
            };
            document.getElementById('cancelSubmit').onclick = () => {
                modal.style.display = 'none';
                setButtonLoading(document.getElementById('submitFinancialButton'), false);
            };
        }

        function logout() {
            logAction('Logout', 'User logged out of admin panel');
            document.getElementById('result').innerHTML = `<span style="color: #34c759;">Logged out successfully.</span>`;
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        function refreshForm() {
            try {
                document.getElementById('adminForm').reset();
                document.getElementById('memberContributionForm').reset();
                document.getElementById('editMember').value = '';
                document.getElementById('editBalanceYear').value = '';
                document.getElementById('editBalanceMonth').value = '';
                document.getElementById('editContributionYear').value = '';
                document.getElementById('editContributionMonth').value = '';
                document.getElementById('balanceYear').value = '';
                document.getElementById('balanceMonth').value = '';
                document.getElementById('contributionYear').value = '';
                document.getElementById('contributionMonth').value = '';
                document.getElementById('dueDate').value = '';
                document.querySelectorAll('.error').forEach(error => {
                    error.textContent = '';
                    error.style.display = 'none';
                });
                document.getElementById('result').innerHTML = '';
                setButtonLoading(document.getElementById('submitFinancialButton'), false);
                setButtonLoading(document.getElementById('submitContributionButton'), false);
                localStorage.removeItem('financialData');
                localStorage.removeItem('adminLogs');
                populateYears('balanceYear');
                populateYears('editBalanceYear');
                populateYears('contributionYear');
                populateYears('editContributionYear');
                fetchData();
                logAction('Refresh Form', 'Form reset and selectors repopulated');
            } catch (error) {
                console.error('Error refreshing form:', error);
                document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">Error: Failed to refresh form (${error.message}). Please try again.</span>`;
            }
        }

        let dataCache = null;

        async function fetchData() {
            try {
                showLoadingSpinner();
                const response = await fetch(`${CONFIG.API_BASE_URL}/data`, {
                    method: 'GET',
                    headers: { 'x-api-key': CONFIG.API_KEY },
                    timeout: CONFIG.FETCH_TIMEOUT
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                dataCache = await response.json();
                hideLoadingSpinner();
                logAction('Fetch Data', 'Successfully fetched financial data');
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">Error: Failed to fetch data (${error.message}).</span>`;
                hideLoadingSpinner();
            }
        }

        async function checkExistingBalanceSheet(month) {
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/data?period=monthly&month=${month}`, {
                    method: 'GET',
                    headers: { 'x-api-key': CONFIG.API_KEY },
                    timeout: CONFIG.FETCH_TIMEOUT
                });
                if (response.status === 404) return false;
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                return !!data; // Returns true if data exists
            } catch (error) {
                console.error('Error checking existing balance sheet:', error);
                return false;
            }
        }

        async function loadBalanceSheetData() {
            const button = document.querySelector('#adminForm .action-button');
            setButtonLoading(button, true);
            const year = document.getElementById('editBalanceYear').value;
            const month = document.getElementById('editBalanceMonth').value;
            if (!year || !month) {
                document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">Please select a year and month to load.</span>`;
                setButtonLoading(button, false);
                return;
            }
            try {
                showLoadingSpinner();
                const response = await fetch(`${CONFIG.API_BASE_URL}/data?period=monthly&month=${month}`, {
                    method: 'GET',
                    headers: { 'x-api-key': CONFIG.API_KEY },
                    timeout: CONFIG.FETCH_TIMEOUT
                });
                if (response.status === 404) {
                    document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">No balance sheet data found for ${month}. Please enter new data.</span>`;
                    setButtonLoading(button, false);
                    hideLoadingSpinner();
                    return;
                }
                                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                document.getElementById('balanceYear').value = year;
                document.getElementById('balanceMonth').value = month;
                document.getElementById('opening_kcb_balance').value = data.opening_kcb_balance || '';
                document.getElementById('total_member_contributions_kcb').value = data.total_member_contributions_kcb || '';
                document.getElementById('membership_fee_kcb').value = data.membership_fee_kcb || '';
                document.getElementById('agm_payments_kcb').value = data.agm_payments_kcb || '';
                document.getElementById('penalties_charged_kcb').value = data.penalties_charged_kcb || '';
                document.getElementById('total_loan_repayments_kcb').value = data.total_loan_repayments_kcb || '';
                document.getElementById('interest_on_loans_kcb').value = data.interest_on_loans_kcb || '';
                document.getElementById('custom_income_1_kcb_name').value = data.custom_income_1_kcb_name || '';
                document.getElementById('custom_income_1_kcb').value = data.custom_income_1_kcb || '';
                document.getElementById('custom_income_2_kcb_name').value = data.custom_income_2_kcb_name || '';
                document.getElementById('custom_income_2_kcb').value = data.custom_income_2_kcb || '';
                document.getElementById('custom_income_3_kcb_name').value = data.custom_income_3_kcb_name || '';
                document.getElementById('custom_income_3_kcb').value = data.custom_income_3_kcb || '';
                document.getElementById('custom_income_4_kcb_name').value = data.custom_income_4_kcb_name || '';
                document.getElementById('custom_income_4_kcb').value = data.custom_income_4_kcb || '';
                document.getElementById('custom_income_5_kcb_name').value = data.custom_income_5_kcb_name || '';
                document.getElementById('custom_income_5_kcb').value = data.custom_income_5_kcb || '';
                document.getElementById('opening_lofty_balance').value = data.opening_lofty_balance || '';
                document.getElementById('membership_fee_lofty').value = data.membership_fee_lofty || '';
                document.getElementById('agm_payments_lofty').value = data.agm_payments_lofty || '';
                document.getElementById('penalties_charged_lofty').value = data.penalties_charged_lofty || '';
                document.getElementById('total_loan_repayments_lofty').value = data.total_loan_repayments_lofty || '';
                document.getElementById('interest_on_deposits_lofty').value = data.interest_on_deposits_lofty || '';
                document.getElementById('custom_income_1_lofty_name').value = data.custom_income_1_lofty_name || '';
                document.getElementById('custom_income_1_lofty').value = data.custom_income_1_lofty || '';
                document.getElementById('custom_income_2_lofty_name').value = data.custom_income_2_lofty_name || '';
                document.getElementById('custom_income_2_lofty').value = data.custom_income_2_lofty || '';
                document.getElementById('custom_income_3_lofty_name').value = data.custom_income_3_lofty_name || '';
                document.getElementById('custom_income_3_lofty').value = data.custom_income_3_lofty || '';
                document.getElementById('custom_income_4_lofty_name').value = data.custom_income_4_lofty_name || '';
                document.getElementById('custom_income_4_lofty').value = data.custom_income_4_lofty || '';
                document.getElementById('custom_income_5_lofty_name').value = data.custom_income_5_lofty_name || '';
                document.getElementById('custom_income_5_lofty').value = data.custom_income_5_lofty || '';
                // Populate Outflow fields
                document.getElementById('total_loan_disbursements_account').value = data.total_loan_disbursements_account || 'kcb';
                document.getElementById('total_loan_disbursements').value = data.total_loan_disbursements_kcb || data.total_loan_disbursements_lofty || '';
                document.getElementById('bank_charges_account').value = data.bank_charges_account || 'kcb';
                document.getElementById('bank_charges').value = data.bank_charges_kcb || data.bank_charges_lofty || '';
                document.getElementById('petty_cash_utilized_account').value = data.petty_cash_utilized_account || 'kcb';
                document.getElementById('petty_cash_utilized').value = data.petty_cash_utilized_kcb || data.petty_cash_utilized_lofty || '';
                document.getElementById('agm_facilitation_account').value = data.agm_facilitation_account || 'kcb';
                document.getElementById('agm_facilitation').value = data.agm_facilitation_kcb || data.agm_facilitation_lofty || '';
                document.getElementById('welfare_kitty_utilized_account').value = data.welfare_kitty_utilized_account || 'kcb';
                document.getElementById('welfare_kitty_utilized').value = data.welfare_kitty_utilized_kcb || data.welfare_kitty_utilized_lofty || '';
                document.getElementById('other_expenses_account').value = data.other_expenses_account || 'kcb';
                document.getElementById('other_expenses').value = data.other_expenses_kcb || data.other_expenses_lofty || '';
                // Populate Custom Outflow fields
                document.getElementById('custom_outflow_1_account').value = data.custom_outflow_1_account || 'kcb';
                document.getElementById('custom_outflow_1_name').value = data.custom_outflow_1_name || '';
                document.getElementById('custom_outflow_1').value = data.custom_outflow_1_kcb || data.custom_outflow_1_lofty || '';
                document.getElementById('custom_outflow_2_account').value = data.custom_outflow_2_account || 'kcb';
                document.getElementById('custom_outflow_2_name').value = data.custom_outflow_2_name || '';
                document.getElementById('custom_outflow_2').value = data.custom_outflow_2_kcb || data.custom_outflow_2_lofty || '';
                document.getElementById('custom_outflow_3_account').value = data.custom_outflow_3_account || 'kcb';
                document.getElementById('custom_outflow_3_name').value = data.custom_outflow_3_name || '';
                document.getElementById('custom_outflow_3').value = data.custom_outflow_3_kcb || data.custom_outflow_3_lofty || '';
                document.getElementById('custom_outflow_4_account').value = data.custom_outflow_4_account || 'kcb';
                document.getElementById('custom_outflow_4_name').value = data.custom_outflow_4_name || '';
                document.getElementById('custom_outflow_4').value = data.custom_outflow_4_kcb || data.custom_outflow_4_lofty || '';
                document.getElementById('custom_outflow_5_account').value = data.custom_outflow_5_account || 'kcb';
                document.getElementById('custom_outflow_5_name').value = data.custom_outflow_5_name || '';
                document.getElementById('custom_outflow_5').value = data.custom_outflow_5_kcb || data.custom_outflow_5_lofty || '';
                // Populate Internal Account Transfer field
                document.getElementById('internal_transfer_direction').value = data.internal_transfer_direction || 'kcb_to_lofty';
                document.getElementById('internal_transfer_amount').value = data.internal_transfer_amount || '';
                document.getElementById('other_income_account').value = data.other_income_account || 'kcb';
                document.getElementById('other_income').value = data.other_income_kcb || data.other_income_lofty || '';
                // Log the action for audit trail
                logAction('Load Balance Sheet', `Loaded balance sheet data for ${month}`);
                document.getElementById('result').innerHTML = `<span style="color: #34c759;">Balance sheet data loaded for ${month}.</span>`;
                hideLoadingSpinner();
                setButtonLoading(button, false);
            } catch (error) {
                console.error('Error loading balance sheet:', error);
                document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">Error: Failed to load balance sheet (${error.message}).</span>`;
                hideLoadingSpinner();
                setButtonLoading(button, false);
            }
        }

        async function loadContributionData() {
            const button = document.querySelector('#memberContributionForm .action-button');
            setButtonLoading(button, true);
            const member = sanitizeInput(document.getElementById('editMember').value);
            const year = document.getElementById('editContributionYear').value;
            const month = document.getElementById('editContributionMonth').value;
            if (!member || !year || !month) {
                document.getElementById('editMemberError').textContent = 'Please enter a member name and select a year and month.';
                document.getElementById('editMemberError').style.display = 'block';
                setButtonLoading(button, false);
                return;
            }
            const matchedMember = fuzzyMatch(member, MEMBERS);
            if (!matchedMember) {
                document.getElementById('editMemberError').textContent = 'Invalid member name. Please enter a valid name.';
                document.getElementById('editMemberError').style.display = 'block';
                setButtonLoading(button, false);
                return;
            }
            try {
                showLoadingSpinner();
                const response = await fetch(`${CONFIG.API_BASE_URL}/contributions?member=${encodeURIComponent(matchedMember)}&month=${month}`, {
                    method: 'GET',
                    headers: { 'x-api-key': CONFIG.API_KEY },
                    timeout: CONFIG.FETCH_TIMEOUT
                });
                if (response.status === 404) {
                    document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">No contribution data found for ${matchedMember} in ${month}.</span>`;
                    setButtonLoading(button, false);
                    hideLoadingSpinner();
                    return;
                }
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                document.getElementById('memberSelect').value = matchedMember;
                document.getElementById('contributionYear').value = year;
                document.getElementById('contributionMonth').value = month;
                document.getElementById('contributionAmount').value = data.amount || '';
                updateDueDate(); // Calculate due date after setting month
                logAction('Load Contribution', `Loaded contribution data for ${matchedMember} in ${month}`);
                document.getElementById('result').innerHTML = `<span style="color: #34c759;">Contribution data loaded for ${matchedMember} in ${month}.</span>`;
                hideLoadingSpinner();
                setButtonLoading(button, false);
            } catch (error) {
                console.error('Error loading contribution:', error);
                document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">Error: Failed to load contribution (${error.message}).</span>`;
                hideLoadingSpinner();
                setButtonLoading(button, false);
            }
        }

        async function submitFinancialData(data, month) {
            try {
                showLoadingSpinner();
                const method = await checkExistingBalanceSheet(month) ? 'PUT' : 'POST';
                const response = await fetch(`${CONFIG.API_BASE_URL}/data`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': CONFIG.API_KEY
                    },
                    body: JSON.stringify({ month, ...data }),
                    timeout: CONFIG.FETCH_TIMEOUT
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                logAction('Submit Financial Data', `Submitted financial data for ${month}`);
                document.getElementById('result').innerHTML = `<span style="color: #34c759;">Financial data ${method === 'PUT' ? 'updated' : 'submitted'} successfully for ${month}.</span>`;
                hideLoadingSpinner();
                refreshForm();
            } catch (error) {
                console.error('Error submitting financial data:', error);
                document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">Error: Failed to submit financial data (${error.message}).</span>`;
                hideLoadingSpinner();
            }
        }

        function calculateBalances(data) {
            // KCB Inflows
            const kcb_inflows = (parseFloat(data.total_member_contributions_kcb) || 0) +
                                (parseFloat(data.membership_fee_kcb) || 0) +
                                (parseFloat(data.agm_payments_kcb) || 0) +
                                (parseFloat(data.penalties_charged_kcb) || 0) +
                                (parseFloat(data.total_loan_repayments_kcb) || 0) +
                                (parseFloat(data.interest_on_loans_kcb) || 0) +
                                (parseFloat(data.custom_income_1_kcb) || 0) +
                                (parseFloat(data.custom_income_2_kcb) || 0) +
                                (parseFloat(data.custom_income_3_kcb) || 0) +
                                (parseFloat(data.custom_income_4_kcb) || 0) +
                                (parseFloat(data.custom_income_5_kcb) || 0) +
                                (parseFloat(data.other_income_kcb) || 0);
            // Lofty Inflows
            const lofty_inflows = (parseFloat(data.membership_fee_lofty) || 0) +
                                 (parseFloat(data.agm_payments_lofty) || 0) +
                                 (parseFloat(data.penalties_charged_lofty) || 0) +
                                 (parseFloat(data.total_loan_repayments_lofty) || 0) +
                                 (parseFloat(data.interest_on_deposits_lofty) || 0) +
                                 (parseFloat(data.custom_income_1_lofty) || 0) +
                                 (parseFloat(data.custom_income_2_lofty) || 0) +
                                 (parseFloat(data.custom_income_3_lofty) || 0) +
                                 (parseFloat(data.custom_income_4_lofty) || 0) +
                                 (parseFloat(data.custom_income_5_lofty) || 0) +
                                 (parseFloat(data.other_income_lofty) || 0);
            // KCB Outflows
            const kcb_outflows = (parseFloat(data.total_loan_disbursements_kcb) || 0) +
                                (parseFloat(data.bank_charges_kcb) || 0) +
                                (parseFloat(data.petty_cash_utilized_kcb) || 0) +
                                (parseFloat(data.agm_facilitation_kcb) || 0) +
                                (parseFloat(data.welfare_kitty_utilized_kcb) || 0) +
                                (parseFloat(data.other_expenses_kcb) || 0) +
                                (parseFloat(data.custom_outflow_1_kcb) || 0) +
                                (parseFloat(data.custom_outflow_2_kcb) || 0) +
                                (parseFloat(data.custom_outflow_3_kcb) || 0) +
                                (parseFloat(data.custom_outflow_4_kcb) || 0) +
                                (parseFloat(data.custom_outflow_5_kcb) || 0);
            // Lofty Outflows
            const lofty_outflows = (parseFloat(data.total_loan_disbursements_lofty) || 0) +
                                  (parseFloat(data.bank_charges_lofty) || 0) +
                                  (parseFloat(data.petty_cash_utilized_lofty) || 0) +
                                  (parseFloat(data.agm_facilitation_lofty) || 0) +
                                  (parseFloat(data.welfare_kitty_utilized_lofty) || 0) +
                                  (parseFloat(data.other_expenses_lofty) || 0) +
                                  (parseFloat(data.custom_outflow_1_lofty) || 0) +
                                  (parseFloat(data.custom_outflow_2_lofty) || 0) +
                                  (parseFloat(data.custom_outflow_3_lofty) || 0) +
                                  (parseFloat(data.custom_outflow_4_lofty) || 0) +
                                  (parseFloat(data.custom_outflow_5_lofty) || 0);
            // Internal Transfers
            const transfer_amount = parseFloat(data.internal_transfer_amount) || 0;
            const kcb_transfer = data.internal_transfer_direction === 'kcb_to_lofty' ? -transfer_amount : transfer_amount;
            const lofty_transfer = data.internal_transfer_direction === 'kcb_to_lofty' ? transfer_amount : -transfer_amount;
            // Calculate Balances
            const kcb_balance = (parseFloat(data.opening_kcb_balance) || 0) + kcb_inflows - kcb_outflows + kcb_transfer;
            const lofty_balance = (parseFloat(data.opening_lofty_balance) || 0) + lofty_inflows - lofty_outflows + lofty_transfer;
            return {
                total_inflows: kcb_inflows + lofty_inflows,
                total_outflows: kcb_outflows + lofty_outflows,
                kcb_balance,
                lofty_balance,
                total_balance: kcb_balance + lofty_balance
            };
        }

        document.getElementById('adminForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const button = document.getElementById('submitFinancialButton');
            setButtonLoading(button, true);
            const validationError = validateFinancialInputs();
            if (validationError) {
                document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">Validation error: ${validationError}</span>`;
                setButtonLoading(button, false);
                return;
            }
            const month = document.getElementById('balanceMonth').value;
            const data = {
                opening_kcb_balance: parseFloat(document.getElementById('opening_kcb_balance').value) || 0,
                total_member_contributions_kcb: parseFloat(document.getElementById('total_member_contributions_kcb').value) || 0,
                membership_fee_kcb: parseFloat(document.getElementById('membership_fee_kcb').value) || 0,
                agm_payments_kcb: parseFloat(document.getElementById('agm_payments_kcb').value) || 0,
                penalties_charged_kcb: parseFloat(document.getElementById('penalties_charged_kcb').value) || 0,
                total_loan_repayments_kcb: parseFloat(document.getElementById('total_loan_repayments_kcb').value) || 0,
                interest_on_loans_kcb: parseFloat(document.getElementById('interest_on_loans_kcb').value) || 0,
                custom_income_1_kcb_name: sanitizeInput(document.getElementById('custom_income_1_kcb_name').value),
                custom_income_1_kcb: parseFloat(document.getElementById('custom_income_1_kcb').value) || 0,
                custom_income_2_kcb_name: sanitizeInput(document.getElementById('custom_income_2_kcb_name').value),
                custom_income_2_kcb: parseFloat(document.getElementById('custom_income_2_kcb').value) || 0,
                custom_income_3_kcb_name: sanitizeInput(document.getElementById('custom_income_3_kcb_name').value),
                custom_income_3_kcb: parseFloat(document.getElementById('custom_income_3_kcb').value) || 0,
                custom_income_4_kcb_name: sanitizeInput(document.getElementById('custom_income_4_kcb_name').value),
                custom_income_4_kcb: parseFloat(document.getElementById('custom_income_4_kcb').value) || 0,
                custom_income_5_kcb_name: sanitizeInput(document.getElementById('custom_income_5_kcb_name').value),
                custom_income_5_kcb: parseFloat(document.getElementById('custom_income_5_kcb').value) || 0,
                opening_lofty_balance: parseFloat(document.getElementById('opening_lofty_balance').value) || 0,
                membership_fee_lofty: parseFloat(document.getElementById('membership_fee_lofty').value) || 0,
                agm_payments_lofty: parseFloat(document.getElementById('agm_payments_lofty').value) || 0,
                penalties_charged_lofty: parseFloat(document.getElementById('penalties_charged_lofty').value) || 0,
                total_loan_repayments_lofty: parseFloat(document.getElementById('total_loan_repayments_lofty').value) || 0,
                interest_on_deposits_lofty: parseFloat(document.getElementById('interest_on_deposits_lofty').value) || 0,
                custom_income_1_lofty_name: sanitizeInput(document.getElementById('custom_income_1_lofty_name').value),
                custom_income_1_lofty: parseFloat(document.getElementById('custom_income_1_lofty').value) || 0,
                custom_income_2_lofty_name: sanitizeInput(document.getElementById('custom_income_2_lofty_name').value),
                custom_income_2_lofty: parseFloat(document.getElementById('custom_income_2_lofty').value) || 0,
                custom_income_3_lofty_name: sanitizeInput(document.getElementById('custom_income_3_lofty_name').value),
                custom_income_3_lofty: parseFloat(document.getElementById('custom_income_3_lofty').value) || 0,
                custom_income_4_lofty_name: sanitizeInput(document.getElementById('custom_income_4_lofty_name').value),
                custom_income_4_lofty: parseFloat(document.getElementById('custom_income_4_lofty').value) || 0,
                custom_income_5_lofty_name: sanitizeInput(document.getElementById('custom_income_5_lofty_name').value),
                custom_income_5_lofty: parseFloat(document.getElementById('custom_income_5_lofty').value) || 0,
                other_income_kcb: document.getElementById('other_income_account').value === 'kcb' ? parseFloat(document.getElementById('other_income').value) || 0 : 0,
                other_income_lofty: document.getElementById('other_income_account').value === 'lofty' ? parseFloat(document.getElementById('other_income').value) || 0 : 0,
                total_loan_disbursements_kcb: document.getElementById('total_loan_disbursements_account').value === 'kcb' ? parseFloat(document.getElementById('total_loan_disbursements').value) || 0 : 0,
                total_loan_disbursements_lofty: document.getElementById('total_loan_disbursements_account').value === 'lofty' ? parseFloat(document.getElementById('total_loan_disbursements').value) || 0 : 0,
                bank_charges_kcb: document.getElementById('bank_charges_account').value === 'kcb' ? parseFloat(document.getElementById('bank_charges').value) || 0 : 0,
                bank_charges_lofty: document.getElementById('bank_charges_account').value === 'lofty' ? parseFloat(document.getElementById('bank_charges').value) || 0 : 0,
                petty_cash_utilized_kcb: document.getElementById('petty_cash_utilized_account').value === 'kcb' ? parseFloat(document.getElementById('petty_cash_utilized').value) || 0 : 0,
                petty_cash_utilized_lofty: document.getElementById('petty_cash_utilized_account').value === 'lofty' ? parseFloat(document.getElementById('petty_cash_utilized').value) || 0 : 0,
                agm_facilitation_kcb: document.getElementById('agm_facilitation_account').value === 'kcb' ? parseFloat(document.getElementById('agm_facilitation').value) || 0 : 0,
                agm_facilitation_lofty: document.getElementById('agm_facilitation_account').value === 'lofty' ? parseFloat(document.getElementById('agm_facilitation').value) || 0 : 0,
                welfare_kitty_utilized_kcb: document.getElementById('welfare_kitty_utilized_account').value === 'kcb' ? parseFloat(document.getElementById('welfare_kitty_utilized').value) || 0 : 0,
                welfare_kitty_utilized_lofty: document.getElementById('welfare_kitty_utilized_account').value === 'lofty' ? parseFloat(document.getElementById('welfare_kitty_utilized').value) || 0 : 0,
                other_expenses_kcb: document.getElementById('other_expenses_account').value === 'kcb' ? parseFloat(document.getElementById('other_expenses').value) || 0 : 0,
                other_expenses_lofty: document.getElementById('other_expenses_account').value === 'lofty' ? parseFloat(document.getElementById('other_expenses').value) || 0 : 0,
                custom_outflow_1_name: sanitizeInput(document.getElementById('custom_outflow_1_name').value),
                custom_outflow_1_kcb: document.getElementById('custom_outflow_1_account').value === 'kcb' ? parseFloat(document.getElementById('custom_outflow_1').value) || 0 : 0,
                custom_outflow_1_lofty: document.getElementById('custom_outflow_1_account').value === 'lofty' ? parseFloat(document.getElementById('custom_outflow_1').value) || 0 : 0,
                custom_outflow_2_name: sanitizeInput(document.getElementById('custom_outflow_2_name').value),
                custom_outflow_2_kcb: document.getElementById('custom_outflow_2_account').value === 'kcb' ? parseFloat(document.getElementById('custom_outflow_2').value) || 0 : 0,
                custom_outflow_2_lofty: document.getElementById('custom_outflow_2_account').value === 'lofty' ? parseFloat(document.getElementById('custom_outflow_2').value) || 0 : 0,
                custom_outflow_3_name: sanitizeInput(document.getElementById('custom_outflow_3_name').value),
                custom_outflow_3_kcb: document.getElementById('custom_outflow_3_account').value === 'kcb' ? parseFloat(document.getElementById('custom_outflow_3').value) || 0 : 0,
                custom_outflow_3_lofty: document.getElementById('custom_outflow_3_account').value === 'lofty' ? parseFloat(document.getElementById('custom_outflow_3').value) || 0 : 0,
                custom_outflow_4_name: sanitizeInput(document.getElementById('custom_outflow_4_name').value),
                custom_outflow_4_kcb: document.getElementById('custom_outflow_4_account').value === 'kcb' ? parseFloat(document.getElementById('custom_outflow_4').value) || 0 : 0,
                custom_outflow_4_lofty: document.getElementById('custom_outflow_4_account').value === 'lofty' ? parseFloat(document.getElementById('custom_outflow_4').value) || 0 : 0,
                custom_outflow_5_name: sanitizeInput(document.getElementById('custom_outflow_5_name').value),
                custom_outflow_5_kcb: document.getElementById('custom_outflow_5_account').value === 'kcb' ? parseFloat(document.getElementById('custom_outflow_5').value) || 0 : 0,
                custom_outflow_5_lofty: document.getElementById('custom_outflow_5_account').value === 'lofty' ? parseFloat(document.getElementById('custom_outflow_5').value) || 0 : 0,
                internal_transfer_direction: document.getElementById('internal_transfer_direction').value,
                internal_transfer_amount: parseFloat(document.getElementById('internal_transfer_amount').value) || 0
            };
            // Calculate balances
            const balances = calculateBalances(data);
            data.total_inflows = balances.total_inflows;
            data.total_outflows = balances.total_outflows;
            data.kcb_balance = balances.kcb_balance;
            data.lofty_balance = balances.lofty_balance;
            data.total_balance = balances.total_balance;
            // Audit check: Ensure balances are non-negative
            if (data.kcb_balance < 0 || data.lofty_balance < 0) {
                document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">Error: Negative balance detected (KCB: ${data.kcb_balance.toFixed(2)}, Lofty: ${data.lofty_balance.toFixed(2)}). Please review inputs.</span>`;
                setButtonLoading(button, false);
                return;
            }
            showConfirmationModal(data, month, () => submitFinancialData(data, month));
        });

        document.getElementById('memberContributionForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const button = document.getElementById('submitContributionButton');
            setButtonLoading(button, true);
            const validationError = validateContributionInputs();
            if (validationError) {
                document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">Validation error: ${validationError}</span>`;
                setButtonLoading(button, false);
                return;
            }
            const member = sanitizeInput(document.getElementById('memberSelect').value);
            const matchedMember = fuzzyMatch(member, MEMBERS);
            if (!matchedMember) {
                document.getElementById('memberSelectError').textContent = 'Invalid member name. Please enter a valid name.';
                document.getElementById('memberSelectError').style.display = 'block';
                setButtonLoading(button, false);
                return;
            }
            const month = document.getElementById('contributionMonth').value;
            const dueDateStr = document.getElementById('dueDate').value;
            const contributionData = {
                member: matchedMember,
                month: month,
                due_date: dueDateStr,
                amount: parseFloat(document.getElementById('contributionAmount').value)
            };
            try {
                showLoadingSpinner();
                const method = await checkExistingContribution(matchedMember, month) ? 'PUT' : 'POST';
                const response = await fetch(`${CONFIG.API_BASE_URL}/contributions`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': CONFIG.API_KEY
                    },
                    body: JSON.stringify(contributionData),
                    timeout: CONFIG.FETCH_TIMEOUT
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                logAction('Submit Contribution', `Submitted contribution for ${matchedMember} in ${month}`);
                document.getElementById('result').innerHTML = `<span style="color: #34c759;">Contribution ${method === 'PUT' ? 'updated' : 'submitted'} successfully for ${matchedMember} in ${month}.</span>`;
                hideLoadingSpinner();
                setButtonLoading(button, false);
                refreshForm();
            } catch (error) {
                console.error('Error submitting contribution:', error);
                document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">Error: Failed to submit contribution (${error.message}).</span>`;
                hideLoadingSpinner();
                setButtonLoading(button, false);
            }
        });

        async function checkExistingContribution(member, month) {
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/contributions?member=${encodeURIComponent(member)}&month=${month}`, {
                    method: 'GET',
                    headers: { 'x-api-key': CONFIG.API_KEY },
                    timeout: CONFIG.FETCH_TIMEOUT
                });
                if (response.status === 404) return false;
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return true;
            } catch (error) {
                console.error('Error checking existing contribution:', error);
                return false;
            }
        }

        function downloadData() {
            try {
                const data = JSON.parse(localStorage.getItem('financialData') || '{}');
                const logs = JSON.parse(localStorage.getItem('adminLogs') || '[]');
                const exportData = { financialData: data, adminLogs: logs };
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `i8-smart-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                logAction('Download Data', 'Downloaded backup of financial data and logs');
                document.getElementById('result').innerHTML = `<span style="color: #34c759;">Data backup downloaded successfully.</span>`;
            } catch (error) {
                console.error('Error downloading data:', error);
                document.getElementById('result').innerHTML = `<span style="color: #e74c3c;">Error: Failed to download data (${error.message}).</span>`;
            }
        }

        // Initialize form
        document.addEventListener('DOMContentLoaded', () => {
            populateYears('balanceYear');
            populateYears('editBalanceYear');
            populateYears('contributionYear');
            populateYears('editContributionYear');
            document.getElementById('balanceYear').addEventListener('change', (e) => populateMonths('balanceMonth', e.target.value));
            document.getElementById('editBalanceYear').addEventListener('change', (e) => populateMonths('editBalanceMonth', e.target.value));
            document.getElementById('contributionYear').addEventListener('change', (e) => populateMonths('contributionMonth', e.target.value));
            document.getElementById('editContributionYear').addEventListener('change', (e) => populateMonths('editContributionMonth', e.target.value));
            const contributionMonthSelect = document.getElementById('contributionMonth');
            if (contributionMonthSelect) {
                contributionMonthSelect.addEventListener('change', updateDueDate);
            }
            fetchData();
            displayLogs();
        });
    </script>
</body>
</html>
